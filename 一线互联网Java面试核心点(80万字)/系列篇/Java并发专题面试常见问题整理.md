# ğŸ’§Javaå¹¶å‘ä¸“é¢˜é¢è¯•å¸¸è§é—®é¢˜æ•´ç†


# 1.å¹¶è¡Œä¸å¹¶å‘æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
å¹¶è¡Œå’Œå¹¶å‘éƒ½æ˜¯æŒ‡å¤šä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œçš„æ¦‚å¿µï¼Œä½†æ˜¯å®ƒä»¬ä¹‹é—´æœ‰ç€æ˜æ˜¾çš„åŒºåˆ«ã€‚

- **å¹¶è¡Œï¼š**å¤šä¸ªä»»åŠ¡åœ¨åŒä¸€æ—¶åˆ»åŒæ—¶è¿è¡Œï¼Œé€šå¸¸éœ€è¦ä½¿ç”¨å¤šä¸ªå¤„ç†å™¨æˆ–è€…å¤šæ ¸å¤„ç†å™¨æ¥å®ç°ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªè®¡ç®—æœºåŒæ—¶æ‰§è¡Œå¤šä¸ªç¨‹åºã€å¤šä¸ªçº¿ç¨‹æˆ–è€…å¤šä¸ªè¿›ç¨‹æ—¶ï¼Œå°±æ˜¯é‡‡ç”¨å¹¶è¡Œçš„æ–¹å¼æ¥å¤„ç†ä»»åŠ¡ï¼Œè¿™æ ·èƒ½å¤Ÿæé«˜è®¡ç®—æœºçš„å¤„ç†æ•ˆç‡ã€‚
- **å¹¶å‘ï¼š**å¤šä¸ªä»»åŠ¡åŒæ—¶è¿›è¡Œï¼Œä½†æ˜¯è¿™äº›ä»»åŠ¡çš„æ‰§è¡Œæ˜¯äº¤æ›¿è¿›è¡Œçš„ï¼Œå³ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œä¸€æ®µæ—¶é—´åï¼Œå†æ‰§è¡Œå¦å¤–ä¸€ä¸ªä»»åŠ¡ã€‚å®ƒæ˜¯é€šè¿‡æ“ä½œç³»ç»Ÿçš„åä½œè°ƒåº¦æ¥å®ç°å„ä¸ªä»»åŠ¡çš„åˆ‡æ¢ï¼Œè¾¾åˆ°çœ‹ä¸Šå»åŒæ—¶è¿›è¡Œçš„æ•ˆæœã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå¤šçº¿ç¨‹ç¨‹åºä¸­çš„å¤šä¸ªçº¿ç¨‹å°±æ˜¯åŒæ—¶è¿è¡Œçš„ï¼Œä½†æ˜¯å› ä¸º CPU åªèƒ½å¤„ç†ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥åœ¨ä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œï¼Œçº¿ç¨‹ä¹‹é—´ä¼šé€šè¿‡ç«äº‰çš„æ–¹å¼æ¥è·å– CPU çš„æ—¶é—´ç‰‡ã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1684069303339-9e112749-93d9-49cd-8d0c-98567a514fc6-924195.png)
![image.png](./img/_kjzzIE5Zr7q1k8N/1713341520869-bff64b5a-c966-44cc-b21f-8b9a8e3ebd58-087609.png)
æ€»çš„æ¥è¯´ï¼Œè™½ç„¶å¹¶è¡Œå’Œå¹¶å‘éƒ½æ˜¯å¤šä»»åŠ¡å¤„ç†çš„æ–¹å¼ï¼Œä½†æ˜¯å¹¶è¡Œæ˜¯é‡‡ç”¨å¤šæ ¸å¤„ç†å™¨ç­‰ç¡¬ä»¶å®ç°ä»»åŠ¡åŒæ­¥æ‰§è¡Œï¼Œè€Œå¹¶å‘åˆ™æ˜¯é€šè¿‡æ“ä½œç³»ç»Ÿçš„è°ƒåº¦ç®—æ³•æ¥åˆç†åœ°åˆ†é…ç³»ç»Ÿèµ„æºï¼Œä½¿å¾—å¤šä¸ªä»»åŠ¡çœ‹ä¸Šå»åŒæ—¶æ‰§è¡Œã€‚

# 2.è¯´è¯´ä»€ä¹ˆæ˜¯è¿›ç¨‹å’Œçº¿ç¨‹?
è¿›ç¨‹å’Œçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„æ¦‚å¿µï¼Œç”¨äºæè¿°ç¨‹åºè¿è¡Œæ—¶çš„æ‰§è¡Œå®ä½“ã€‚
**è¿›ç¨‹ï¼š**ä¸€ä¸ªç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªå®ä¾‹ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬ä¸èƒ½ç›´æ¥å…±äº«å†…å­˜ã€‚è¿›ç¨‹çš„ç‰¹ç‚¹åŒ…æ‹¬ï¼š

- éœ€è¦å ç”¨ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼›
- å¯ä»¥å¹¶å‘åœ°æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼›
- è¿›ç¨‹ä¹‹é—´éœ€è¦é€šè¿‡è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æ¥äº¤æ¢æ•°æ®ï¼›

**çº¿ç¨‹ï¼š**è¿›ç¨‹ä¸­çš„ä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹å…±äº«è¿›ç¨‹çš„å†…å­˜ç©ºé—´ã€‚çº¿ç¨‹çš„ç‰¹ç‚¹åŒ…æ‹¬ï¼š

- çº¿ç¨‹å…±äº«è¿›ç¨‹å†…å­˜ç©ºé—´ï¼Œå¯ä»¥æ–¹ä¾¿ã€é«˜æ•ˆåœ°è®¿é—®å˜é‡ï¼›
- åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘åœ°æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼›
- çº¿ç¨‹ä¹‹é—´åˆ‡æ¢å¼€é”€å°ï¼Œå¯ä»¥å®ç°æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œä¾‹å¦‚ UI çº¿ç¨‹æ§åˆ¶ç•Œé¢åˆ·æ–°ï¼Œå·¥ä½œçº¿ç¨‹è¿›è¡Œè€—æ—¶çš„è®¡ç®—ç­‰ã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1684221156232-f5c817fc-ace1-4ae3-a910-7c2a06285a0d-816448.png)
çº¿ç¨‹ç›¸æ¯”äºè¿›ç¨‹ï¼Œçº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯å¼€é”€è¾ƒå°ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ä¹Ÿè¾ƒå°ï¼Œå› æ­¤çº¿ç¨‹æ˜¯å®ç°å¤šä»»åŠ¡å¹¶å‘çš„ä¸€ç§æ›´åŠ è½»é‡çº§çš„æ–¹å¼ã€‚

# 3.è¯´è¯´çº¿ç¨‹æœ‰å‡ ç§åˆ›å»ºæ–¹å¼ï¼Ÿ
Javaä¸­åˆ›å»ºçº¿ç¨‹ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ï¼š
![1684507798397-affa736d-97d8-49cc-9292-f3f605e49001.jpeg](./img/_kjzzIE5Zr7q1k8N/1684507798397-affa736d-97d8-49cc-9292-f3f605e49001-103074.jpeg)

- å®šä¹‰Threadç±»çš„å­ç±»ï¼Œå¹¶é‡å†™è¯¥ç±»çš„runæ–¹æ³•
```java
/**
 * ç»§æ‰¿Thread-é‡å†™runæ–¹æ³•
 * Created by BaiLi
 */
public class BaiLiThread {
    public static void main(String[] args) {
        MyThread myThread = new MyThread();
        myThread.run();
    }
}
class MyThread extends Thread {
    @Override
    public void run() {
        System.out.println("ä¸€é”®ä¸‰è¿");
    }
}
```

- å®šä¹‰Runnableæ¥å£çš„å®ç°ç±»ï¼Œå¹¶é‡å†™è¯¥æ¥å£çš„run()æ–¹æ³•
```java
/**
 * å®ç°Runnable-é‡å†™run()æ–¹æ³•
 * Created by BaiLi
 */
public class BaiLiRunnable {
    public static void main(String[] args) {
        MyRunnable myRunnable = new MyRunnable();
        new Thread(myRunnable).start();
    }
}
class MyRunnable implements Runnable {

    @Override
    public void run() {
        System.out.println("ä¸€é”®ä¸‰è¿");
    }
}
```

- å®šä¹‰Callableæ¥å£çš„å®ç°ç±»ï¼Œå¹¶é‡å†™è¯¥æ¥å£çš„call()æ–¹æ³•ï¼Œä¸€èˆ¬é…åˆFutureTaskä½¿ç”¨
```java
/**
 * å®ç°Callable-é‡å†™call()æ–¹æ³•
 * Created by BaiLi
 */
public class BaiLiCallable {
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        FutureTask<String> ft = new FutureTask<String>(new MyCallable());
        Thread thread = new Thread(ft);
        thread.start();
        System.out.println(ft.get());
    }
}
class MyCallable implements Callable<String> {

    @Override
    public String call() throws Exception {
        return "ä¸€é”®ä¸‰è¿";
    }
}
```

# 4.ä¸ºä»€ä¹ˆè°ƒç”¨start()æ–¹æ³•æ—¶ä¼šæ‰§è¡Œrun()æ–¹æ³•ï¼Œé‚£æ€ä¹ˆä¸ç›´æ¥è°ƒç”¨run()æ–¹æ³•ï¼Ÿ
JVMæ‰§è¡Œstartæ–¹æ³•ï¼Œä¼šå…ˆåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œç”±åˆ›å»ºå‡ºæ¥çš„æ–°çº¿ç¨‹å»æ‰§è¡Œthreadçš„runæ–¹æ³•ï¼Œè¿™æ‰èµ·åˆ°å¤šçº¿ç¨‹çš„æ•ˆæœã€‚
start()å’Œrun()çš„ä¸»è¦åŒºåˆ«å¦‚ä¸‹ï¼š

- startæ–¹æ³•å¯ä»¥å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œrunæ–¹æ³•åªæ˜¯ç±»çš„ä¸€ä¸ªæ™®é€šæ–¹æ³•è€Œå·²ï¼Œå¦‚æœç›´æ¥è°ƒç”¨runæ–¹æ³•ï¼Œç¨‹åºä¸­ä¾ç„¶åªæœ‰ä¸»çº¿ç¨‹è¿™ä¸€ä¸ªçº¿ç¨‹ã€‚
- startæ–¹æ³•å®ç°äº†å¤šçº¿ç¨‹ï¼Œè€Œrunæ–¹æ³•æ²¡æœ‰å®ç°å¤šçº¿ç¨‹ã€‚
- startä¸èƒ½è¢«é‡å¤è°ƒç”¨ï¼Œè€Œrunæ–¹æ³•å¯ä»¥ã€‚
- startæ–¹æ³•ä¸­çš„runä»£ç å¯ä»¥ä¸æ‰§è¡Œå®Œï¼Œå°±ç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯è¯´è¿›è¡Œäº†**çº¿ç¨‹åˆ‡æ¢**ã€‚ç„¶è€Œï¼Œå¦‚æœç›´æ¥è°ƒç”¨runæ–¹æ³•ï¼Œå°±å¿…é¡»ç­‰å¾…å…¶ä»£ç å…¨éƒ¨æ‰§è¡Œå®Œæ‰èƒ½ç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»£ç ã€‚
- ![image.png](./img/_kjzzIE5Zr7q1k8N/1684467966836-afd48d78-bbdc-4346-aea8-72fc3da3325b-953060.png)
```java
/**
 * Created by BaiLi
 */
public class BaiLiDemo {
    public static void main(String[] args) {
        Thread thread = new Thread(() -> System.out.println(Thread.currentThread().getName()+":ä¸€é”®ä¸‰è¿"));
        thread.start();
        thread.run();
        thread.run();
        System.out.println(Thread.currentThread().getName()+":ä¸€é”®ä¸‰è¿ + åˆ†äº«");
    }
}
```

# 5.çº¿ç¨‹æœ‰å“ªäº›å¸¸ç”¨çš„è°ƒåº¦æ–¹æ³•
![1684477906024-8e105c08-6c8e-4d83-a39f-5130a235e312.jpeg](./img/_kjzzIE5Zr7q1k8N/1684477906024-8e105c08-6c8e-4d83-a39f-5130a235e312-861629.jpeg)
```java
import java.time.LocalTime;

/**
 * Created by BaiLi
 */
public class WaitDemo {
    public static void main(String[] args) throws InterruptedException {
        Object lock = new Object();
        Thread thread1 = new Thread(() -> {
            try {
                synchronized (lock) {
                    System.out.println("çº¿ç¨‹è¿›å…¥æ°¸ä¹…ç­‰å¾…"+ LocalTime.now());
                    lock.wait();
                    System.out.println("çº¿ç¨‹æ°¸ä¹…ç­‰å¾…å”¤é†’"+ LocalTime.now());
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "Thread-1");

        Thread thread2 = new Thread(() -> {
            try {
                synchronized (lock) {
                    System.out.println("çº¿ç¨‹è¿›å…¥è¶…æ—¶ç­‰å¾…"+ LocalTime.now());
                    lock.wait(5000);
                    System.out.println("çº¿ç¨‹è¶…æ—¶ç­‰å¾…å”¤é†’"+ LocalTime.now());
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "Thread-2");

        thread1.start();
        thread2.start();
        Thread.sleep(1000);
        synchronized (lock) {
            lock.notifyAll();
        }
        thread1.join();
        thread2.join();
    }
}
```
```java
public class YieldDemo extends Thread {
    public void run() {
        for (int i = 0; i < 5; i++) {
            System.out.println(Thread.currentThread().getName() + " is running");
            Thread.yield(); // è°ƒç”¨ yield æ–¹æ³•ï¼Œè®©å‡º CPU æ‰§è¡Œæ—¶é—´
        }
    }

    public static void main(String[] args) {
        YieldDemo demo = new YieldDemo();

        Thread t1 = new Thread(demo);
        Thread t2 = new Thread(demo);

        t1.start();
        t2.start();
    }
}
```
```java
/**
 * Created by BaiLi
 */
public class InterruptedDemo extends Thread {
    @Override
    public void run() {
        System.out.println(Thread.currentThread().getName()+":å½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€_"+isInterrupted());
        if(isInterrupted()){
            if(!interrupted()){
                System.out.println(Thread.currentThread().getName()+":å½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€_"+isInterrupted());
            }
        }
    }

    public static void main(String[] args) {
        InterruptedDemo interruptedDemo = new InterruptedDemo();
        interruptedDemo.start();

        interruptedDemo.interrupt();
        System.out.println(Thread.currentThread().getName()+":å½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€_"+Thread.interrupted());
    }
}

```

# 6.çº¿ç¨‹æœ‰å‡ ç§çŠ¶æ€ï¼Ÿ
![1684495224848-fe529b07-dfe1-4de3-a561-46eeae238ee6.jpeg](./img/_kjzzIE5Zr7q1k8N/1684495224848-fe529b07-dfe1-4de3-a561-46eeae238ee6-159593.jpeg)
çº¿ç¨‹åœ¨è‡ªèº«çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œ å¹¶ä¸æ˜¯å›ºå®šåœ°å¤„äºæŸä¸ªçŠ¶æ€ï¼Œè€Œæ˜¯éšç€ä»£ç çš„æ‰§è¡Œåœ¨ä¸åŒçš„çŠ¶æ€ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œå¦‚ä¸‹å›¾ï¼š
![image.png](./img/_kjzzIE5Zr7q1k8N/1684495292553-2280ce19-0365-497f-acf4-d3eb6934d466-464562.png)

# 7.ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Ÿ
çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æŒ‡çš„æ˜¯åœ¨å¤šçº¿ç¨‹è¿è¡Œæ—¶ï¼Œæ“ä½œç³»ç»Ÿä»å½“å‰æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹ä¸­ä¿å­˜å…¶ä¸Šä¸‹æ–‡ï¼ˆåŒ…æ‹¬å½“å‰çº¿ç¨‹çš„å¯„å­˜å™¨ã€ç¨‹åºæŒ‡é’ˆã€æ ˆæŒ‡é’ˆç­‰çŠ¶æ€ä¿¡æ¯ï¼‰ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯æ¢å¤åˆ°å¦ä¸€ä¸ªç­‰å¾…æ‰§è¡Œçš„çº¿ç¨‹ä¸­ï¼Œä»è€Œå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ã€‚
![image.png](./img/_kjzzIE5Zr7q1k8N/1684139069282-8e2923ea-d794-4e12-950b-a6a1c8f6d011-356633.png)![image.png](./img/_kjzzIE5Zr7q1k8N/1684138548040-609a23b8-dd6c-4964-a303-3a0f91893059-392075.png)

# 8.çº¿ç¨‹é—´æœ‰å“ªäº›é€šä¿¡æ–¹å¼ï¼Ÿ
![1684741358058-a7251798-bf54-4ff9-bdfc-b2f8c478dbd5.jpeg](./img/_kjzzIE5Zr7q1k8N/1684741358058-a7251798-bf54-4ff9-bdfc-b2f8c478dbd5-944162.jpeg)
çº¿ç¨‹é—´é€šä¿¡æ˜¯æŒ‡åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«ä¿¡æ¯æˆ–è€…ååŒå®ŒæˆæŸä¸€ä»»åŠ¡çš„è¿‡ç¨‹ã€‚å¸¸ç”¨çš„çº¿ç¨‹é—´é€šä¿¡æ–¹å¼æœ‰ä»¥ä¸‹å‡ ç§ï¼š

- **å…±äº«å˜é‡ï¼š**å…±äº«å˜é‡æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®å’Œä¿®æ”¹çš„å˜é‡ï¼Œå®ƒä»¬é€šå¸¸æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºçš„ã€‚å¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªå…±äº«å˜é‡è¿›è¡Œè¯»å†™æ“ä½œæ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°ç«æ€æ¡ä»¶å¯¼è‡´æ•°æ®é”™è¯¯æˆ–ç¨‹åºå¼‚å¸¸ã€‚å› æ­¤éœ€è¦ä½¿ç”¨åŒæ­¥æœºåˆ¶æ¯”å¦‚synchronizedã€Lockç­‰æ¥ä¿è¯çº¿ç¨‹å®‰å…¨
- **ç®¡é“é€šä¿¡ï¼š**ç®¡é“æ˜¯ä¸€ç§åŸºäºæ–‡ä»¶æè¿°ç¬¦çš„é€šä¿¡æœºåˆ¶ï¼Œå½¢æˆä¸€ä¸ªå•å‘é€šä¿¡çš„æ•°æ®æµç®¡é“ã€‚å®ƒé€šå¸¸ç”¨äºåªæœ‰ä¸¤ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹å°†æ•°æ®å†™å…¥åˆ°ç®¡é“ï¼ˆç®¡é“çš„è¾“å‡ºç«¯å£ï¼‰ï¼Œè€Œå¦ä¸€ä¸ªè¿›ç¨‹ä»ç®¡é“çš„è¾“å…¥ç«¯å£è¯»å–æ•°æ®
- **ä¿¡å·é‡ï¼š**ä¿¡å·é‡æ˜¯ä¸€ç§è®¡æ•°å™¨ï¼Œç”¨äºæ§åˆ¶å¤šä¸ªçº¿ç¨‹å¯¹èµ„æºçš„è®¿é—®ã€‚å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è®¿é—®èµ„æºæ—¶ï¼Œå®ƒéœ€è¦ç”³è¯·è·å–ä¿¡å·é‡ï¼Œå¦‚æœä¿¡å·é‡çš„è®¡æ•°å™¨å€¼å¤§äº 0ï¼Œåˆ™å¯ä»¥è®¿é—®èµ„æºï¼Œå¦åˆ™è¯¥çº¿ç¨‹å°±ä¼šç­‰å¾…ã€‚å½“çº¿ç¨‹ç»“æŸè®¿é—®èµ„æºåï¼Œéœ€è¦é‡Šæ”¾ä¿¡å·é‡ï¼Œå¹¶å°†è®¡æ•°å™¨åŠ 1
- **æ¡ä»¶å˜é‡ï¼š**æ¡ä»¶å˜é‡æ˜¯ä¸€ç§é€šçŸ¥æœºåˆ¶ï¼Œç”¨äºåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ä¼ é€’çŠ¶æ€ä¿¡æ¯å’Œæ§åˆ¶ä¿¡æ¯ã€‚å½“æŸä¸ªçº¿ç¨‹éœ€è¦ç­‰å¾…æŸä¸ªæ¡ä»¶å˜é‡å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå®ƒå¯ä»¥è°ƒç”¨ wait() æ–¹æ³•æŒ‚èµ·ï¼Œå¹¶ä¸”é‡Šæ”¾æ‰€å ç”¨çš„é”ã€‚å½“æŸä¸ªçº¿ç¨‹æ»¡è¶³æ¡ä»¶åï¼Œå¯ä»¥è°ƒç”¨ notify() æˆ–è€… signal() æ–¹æ³•æ¥é€šçŸ¥ç­‰å¾…è¯¥æ¡ä»¶å˜é‡çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œ
```java
/**
 * å…±äº«å˜é‡
 * åˆ›å»ºäººï¼šç™¾é‡Œ
 */
public class BaiLiSharedMemoryDemo {
    public static void main(String[] args) {
        ArrayList<Integer> integers = new ArrayList<>();
        Thread producerThread = new Thread(() -> {
            for (int i = 0; i < 5; i++) {
                synchronized (integers) {
                    integers.add(i);
                    System.out.println(Thread.currentThread().getName() + "_Producer:" + i);
                }
                try {
                    Thread.sleep(2000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "ProducerThread");

        Thread consumeThread = new Thread(() -> {
            while (true) {
                synchronized (integers) {
                    if (!integers.isEmpty()) {
                        Integer integer = integers.remove(0);
                        System.out.println(Thread.currentThread().getName() + "_Consume:" + integer);
                    }
                }
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }, "ConsumeThread");
        producerThread.start();
        consumeThread.start();
    }
}
```
```java
/**
 * ç®¡é“é€šä¿¡æ¨¡å¼
 * åˆ›å»ºäººï¼šç™¾é‡Œ
 */
public class BaiLiPipedStreamDemo {
    public static void main(String[] args) throws IOException {
        //è¾“å‡ºç®¡é“
        PipedOutputStream pipedOutputStream = new PipedOutputStream();
        //è¾“å…¥ç®¡é“
        PipedInputStream pipedInputStream = new PipedInputStream();

        pipedInputStream.connect(pipedOutputStream);

        Thread producerThread = new Thread(() -> {
            try {
                for (int i = 0; i < 5; i++) {
                    pipedOutputStream.write(i);
                    System.out.println(Thread.currentThread().getName() + "_Produce: " + i);
                    Thread.sleep(2000);
                }
                pipedOutputStream.close();
            } catch (IOException | InterruptedException e) {
                e.printStackTrace();
            }
        }, "ProducerThread");

        Thread consumeThread = new Thread(() -> {
            try {
                for (int i = 0; i < 5; i++) {
                    while (true) {
                        int read = pipedInputStream.read();
                        if (read != -1) {
                            System.out.println(Thread.currentThread().getName() + "_Consume: " + read);
                        } else {
                            break;
                        }
                        Thread.sleep(1000);
                    }
                }
                pipedInputStream.close();
            } catch (IOException | InterruptedException e) {
                e.printStackTrace();
            }
        }, "ConsumeThread");

        producerThread.start();
        consumeThread.start();
    }
}

```
```java
/**
 * ä¿¡å·é‡
 * åˆ›å»ºäººï¼šç™¾é‡Œ
 */
public class BaiLiSemaphoreDemo {
    public static void main(String[] args) {
        // å®ä¾‹åŒ–ä¸€ä¸ªä¿¡å·é‡å¯¹è±¡ï¼Œåˆå§‹å€¼ä¸º 0
        Semaphore semaphore = new Semaphore(0);

        // åˆ›å»ºç”Ÿäº§è€…çº¿ç¨‹
        Thread producerThread = new Thread(() -> {
            try {
                for (int i = 0; i < 5; i++) {
                    System.out.println(Thread.currentThread().getName() + "_Producer:" + i);
                    semaphore.release(); // æŠŠä¿¡å·é‡çš„è®¡æ•°å™¨åŠ  1
                    Thread.sleep(1000); //æ¨¡æ‹Ÿåœé¡¿
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "ProducerThread");

        // åˆ›å»ºæ¶ˆè´¹è€…çº¿ç¨‹
        Thread consumeThread = new Thread(() -> {
            try {
                for (int i = 0; i < 5; i++) {
                    semaphore.acquire(); // è¯·æ±‚å æœ‰ä¿¡å·é‡ï¼Œå¦‚æœè®¡æ•°å™¨ä¸ä¸º 0ï¼Œè®¡æ•°å™¨å‡ 1ï¼Œå¦åˆ™çº¿ç¨‹é˜»å¡ç­‰å¾…
                    System.out.println(Thread.currentThread().getName() + "_Consume:" + i);
                    Thread.sleep(1000); //æ¨¡æ‹Ÿåœé¡¿
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }, "ConsumeThread");

        producerThread.start();
        consumeThread.start();
    }
}
```
```java
/**
 * æ¡ä»¶å˜é‡|å¯é‡å…¥é”
 * åˆ›å»ºäººï¼šç™¾é‡Œ
 */
public class BaiLIConditionDemo {
    public static void main(String[] args) {
        // å®ä¾‹åŒ–ä¸€ä¸ªå¯é‡å…¥é”å¯¹è±¡
        ReentrantLock lock = new ReentrantLock();
        // è·å–è¯¥é”å¯¹è±¡çš„æ¡ä»¶å˜é‡
        Condition condition = lock.newCondition();

        // åˆ›å»ºç”Ÿäº§è€…çº¿ç¨‹
        Thread producerThread = new Thread(() -> {
            try {
                lock.lock(); // è·å–é”å¯¹è±¡
                for (int i = 1; i <= 5; i++) {
                    System.out.println(Thread.currentThread().getName() + " produce: " + i);
                    condition.signal(); // å”¤é†’å¤„äºç­‰å¾…çŠ¶æ€ä¸‹çš„æ¶ˆè´¹è€…çº¿ç¨‹
                    condition.await(); // ä½¿å½“å‰çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå¹¶é‡Šæ”¾é”å¯¹è±¡
                    Thread.sleep(1000);
                }
                condition.signal(); // é¿å…æ¶ˆè´¹è€…çº¿ç¨‹ä¸€ç›´ç­‰å¾…
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                lock.unlock(); // é‡Šæ”¾é”å¯¹è±¡
            }
        }, "producer");

        // åˆ›å»ºæ¶ˆè´¹è€…çº¿ç¨‹
        Thread consumerThread = new Thread(() -> {
            try {
                lock.lock(); // è·å–é”å¯¹è±¡
                for (int i = 1; i <= 5; i++) {
                    System.out.println(Thread.currentThread().getName() + " consume: " + i);
                    condition.signal(); // å”¤é†’å¤„äºç­‰å¾…çŠ¶æ€ä¸‹çš„ç”Ÿäº§è€…çº¿ç¨‹
                    condition.await(); // ä½¿å½“å‰çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå¹¶é‡Šæ”¾é”å¯¹è±¡
                    Thread.sleep(1000);
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                lock.unlock(); // é‡Šæ”¾é”å¯¹è±¡
            }
        }, "consumer");

        // å¯åŠ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çº¿ç¨‹
        producerThread.start();
        consumerThread.start();
    }
}
```

# 9.ThreadLocalæ˜¯ä»€ä¹ˆï¼Ÿ
ThreadLocalä¹Ÿå°±æ˜¯çº¿ç¨‹æœ¬åœ°å˜é‡ã€‚å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªThreadLocalå˜é‡ï¼Œé‚£ä¹ˆè®¿é—®è¿™ä¸ªå˜é‡çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¿™ä¸ªå˜é‡çš„ä¸€ä¸ªæœ¬åœ°æ‹·è´ï¼Œå¤šä¸ªçº¿ç¨‹æ“ä½œè¿™ä¸ªå˜é‡çš„æ—¶å€™ï¼Œå®é™…æ˜¯æ“ä½œè‡ªå·±æœ¬åœ°å†…å­˜é‡Œé¢çš„å˜é‡ï¼Œä»è€Œèµ·åˆ°çº¿ç¨‹éš”ç¦»çš„ä½œç”¨ï¼Œé¿å…äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚
![image.png](./img/_kjzzIE5Zr7q1k8N/1684141183356-24c6f19d-8823-4a3c-a62b-3d743d5bd3de-155366.png)
ThreadLocalæ˜¯æ•´ä¸ªçº¿ç¨‹çš„å…¨å±€å˜é‡ï¼Œä¸æ˜¯æ•´ä¸ªç¨‹åºçš„å…¨å±€å˜é‡ã€‚
```java
/**
 * ThreadLocal
 * åˆ›å»ºäººï¼šç™¾é‡Œ
 */
public class BaiLiThreadLocalDemo {
    //åˆ›å»ºä¸€ä¸ªé™æ€çš„threadLocalå˜é‡ï¼Œè¢«æ‰€æœ‰çº¿ç¨‹å…±äº«
    static ThreadLocal<Integer> threadLocal = new ThreadLocal<>();

    public static void main(String[] args) throws InterruptedException {
        Thread thread1 = new Thread(() -> {
            System.out.println(threadLocal.get());
            threadLocal.set(0);
            System.out.println(threadLocal.get());
        },"Thread-1");

        Thread thread2 = new Thread(() -> {
            System.out.println(threadLocal.get());
            threadLocal.set(1);
            System.out.println(threadLocal.get());
        },"Thread-2");

        thread1.start();
        thread1.join();
        thread2.start();
        thread2.join();
    }
}
```

# 10.ThreadLocalæ€ä¹ˆå®ç°ï¼Ÿ

- ThreadLocalæ˜¯Javaä¸­æ‰€æä¾›çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨æœºåˆ¶ï¼Œå¯ä»¥åˆ©ç”¨è¯¥æœºåˆ¶å°†æ•°æ®ç¼“å­˜åœ¨æŸä¸ªçº¿ç¨‹å†…éƒ¨ï¼Œè¯¥çº¿ç¨‹å¯ä»¥åœ¨ä»»æ„æ—¶åˆ»ã€ä»»æ„æ–¹æ³•ä¸­è·å–ç¼“å­˜çš„æ•°æ®
- ThreadLocalåº•å±‚æ˜¯é€šè¿‡ThreadLocalMapæ¥å®ç°çš„ï¼Œæ¯ä¸ªThreadå¯¹è±¡ï¼ˆæ³¨æ„ä¸æ˜¯ThreadLocalå¯¹è±¡ï¼‰ä¸­éƒ½å­˜åœ¨ä¸€ä¸ªThreadLocalMapï¼ŒMapçš„keyä¸ºThreadLocalå¯¹è±¡ï¼ŒMapçš„valueä¸ºéœ€è¦ç¼“å­˜çš„å€¼

![image.png](./img/_kjzzIE5Zr7q1k8N/1684846794799-75951a8b-1bbe-4208-a911-982716a1df01-031104.png)
å®ç°æ–¹å¼è§‚å¯ŸThreadLocalçš„setæ–¹æ³•ï¼š
```java
public void set(T value) {
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null)
        map.set(this, value);
    else
        createMap(t, value);
}

ThreadLocalMap getMap(Thread t) {
    return t.threadLocals;
}

ThreadLocal.ThreadLocalMap threadLocals = null;

static class Entry extends WeakReference<ThreadLocal<?>> {
    Object value;

    Entry(ThreadLocal<?> k, Object v) {
        super(k);
        value = v;
    }
}
```

# 11.ThreadLocalå†…å­˜æ³„éœ²æ˜¯æ€ä¹ˆå›äº‹?
å¦‚æœåœ¨çº¿ç¨‹æ± ä¸­ä½¿ç”¨ThreadLocalä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Œå› ä¸ºå½“ThreadLocalå¯¹è±¡ä½¿ç”¨å®Œä¹‹åï¼Œåº”è¯¥è¦æŠŠè®¾ç½®çš„keyï¼Œvalueï¼Œä¹Ÿå°±æ˜¯Entryå¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œä½†çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä¸ä¼šå›æ”¶ï¼Œè€Œçº¿ç¨‹å¯¹è±¡æ˜¯é€šè¿‡å¼ºå¼•ç”¨æŒ‡å‘ThreadLocalMapï¼ŒThreadLocalMapä¹Ÿæ˜¯é€šè¿‡å¼ºå¼•ç”¨æŒ‡å‘Entryå¯¹è±¡ï¼Œçº¿ç¨‹ä¸è¢«å›æ”¶ï¼ŒEntryå¯¹è±¡ä¹Ÿå°±ä¸ä¼šè¢«å›æ”¶ï¼Œä»è€Œå‡ºç°å†…å­˜æ³„æ¼ã€‚
è§£å†³åŠæ³•æ˜¯åœ¨ä½¿ç”¨äº†ThreadLocalå¯¹è±¡ä¹‹åï¼Œæ‰‹åŠ¨è°ƒç”¨ThreadLocalçš„removeæ–¹æ³•ï¼Œæ‰‹åŠ¨æ¸…é™¤Entryå¯¹è±¡ã€‚
![image.png](./img/_kjzzIE5Zr7q1k8N/1684834628234-a5470f8c-2d3e-473f-a2de-e98feba7cc33-094760.png)
```java
package communication;

import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

/**
 * åˆ›å»ºäººï¼šç™¾é‡Œ
 */
public class BaiLiThreadLocalMemoryLeakDemo {
    private static final ThreadLocal<byte[]> threadLocal = new ThreadLocal<byte[]>();

    public static void main(String[] args) throws Exception {
        ExecutorService executorService = Executors.newFixedThreadPool(5);
        for (int i = 0; i < 100; i++) {
            executorService.execute(() -> {
                byte[] data = new byte[50240 * 10240];
                threadLocal.set(data);
                // ä¸è°ƒç”¨ remove æ–¹æ³•ï¼Œä¼šå¯¼è‡´å†…å­˜æ³„æ¼
                //threadLocal.remove();
            });
        }
        executorService.shutdown();
        executorService.awaitTermination(1, TimeUnit.MINUTES);
    }
}
```

# 12.ThreadLocalMapçš„ç»“æ„
ThreadLocalMapè™½ç„¶è¢«ç§°ä¸ºMapï¼Œä½†æ˜¯å…¶å®å®ƒæ˜¯æ²¡æœ‰å®ç°Mapæ¥å£çš„ï¼Œä¸è¿‡ç»“æ„è¿˜æ˜¯å’ŒHashMapæ¯”è¾ƒç±»ä¼¼çš„ï¼Œä¸»è¦å…³æ³¨çš„æ˜¯ä¸¤ä¸ªè¦ç´ ï¼š**å…ƒç´ æ•°ç»„å’Œæ•£åˆ—æ–¹æ³•**ã€‚
![image.png](./img/_kjzzIE5Zr7q1k8N/1684929312973-a083fc5c-5c4f-4370-a9d4-b28d8f3f68bd-453934.png)

- **å…ƒç´ æ•°ç»„**ä¸€ä¸ªtableæ•°ç»„ï¼Œå­˜å‚¨Entryç±»å‹çš„å…ƒç´ ï¼ŒEntryæ˜¯ThreadLocalå¼±å¼•ç”¨ä½œä¸ºkeyï¼ŒObjectä½œä¸ºvalueçš„ç»“æ„ã€‚
```java
private Entry[] table;
```

- **æ•£åˆ—æ–¹æ³•**å°±æ˜¯æ€ä¹ˆæŠŠå¯¹åº”çš„keyæ˜ å°„åˆ°tableæ•°ç»„çš„ç›¸åº”ä¸‹æ ‡ï¼ŒThreadLocalMapç”¨çš„æ˜¯å“ˆå¸Œå–ä½™æ³•ï¼Œå–å‡ºkeyçš„threadLocalHashCodeï¼Œç„¶åå’Œtableæ•°ç»„é•¿åº¦å‡ä¸€&è¿ç®—ï¼ˆç›¸å½“äºå–ä½™ï¼‰
```java
int i = key.threadLocalHashCode & (table.length - 1);
```
è¡¥å……ä¸€ç‚¹æ¯åˆ›å»ºä¸€ä¸ªThreadLocalå¯¹è±¡ï¼Œå®ƒå°±ä¼šæ–°å¢0x61c88647ï¼Œè¿™ä¸ªå€¼å¾ˆç‰¹æ®Šï¼Œå®ƒæ˜¯æ–æ³¢é‚£å¥‘æ•°ä¹Ÿå«é»„é‡‘åˆ†å‰²æ•°ã€‚è¿™æ ·å¸¦æ¥çš„å¥½å¤„å°±æ˜¯**hashåˆ†å¸ƒéå¸¸å‡åŒ€**ã€‚
```java
private static final int HASH_INCREMENT = 0x61c88647;

private static int nextHashCode() {
    return nextHashCode.getAndAdd(HASH_INCREMENT);
}
```

# 13.ThreadLocalMapæ€ä¹ˆè§£å†³Hashå†²çªçš„ï¼Ÿ
æˆ‘ä»¬å¯èƒ½éƒ½çŸ¥é“HashMapä½¿ç”¨äº†é“¾è¡¨æ¥è§£å†³å†²çªï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„é“¾åœ°å€æ³•ã€‚
ThreadLocalMapå†…éƒ¨ä½¿ç”¨çš„æ˜¯å¼€æ”¾åœ°å€æ³•æ¥è§£å†³ Hashå†²çªçš„é—®é¢˜ã€‚å…·ä½“æ¥è¯´ï¼Œå½“å‘ç”ŸHashå†²çªæ—¶ï¼ŒThreadLocalMapä¼šå°†**å½“å‰æ’å…¥çš„å…ƒç´ ä»å†²çªä½ç½®å¼€å§‹ä¾æ¬¡å¾€åéå†ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªç©ºé—²çš„ä½ç½®ï¼Œç„¶åæŠŠè¯¥å…ƒç´ æ”¾åœ¨è¿™ä¸ªç©ºé—²ä½ç½®**ã€‚è¿™æ ·å³ä½¿å‡ºç°äº†Hashå†²çªï¼Œä¸ä¼šå½±å“åˆ°å·²ç»æ’å…¥çš„å…ƒç´ ï¼Œè€Œåªæ˜¯ä¼šå½±å“åˆ°æ–°çš„æ’å…¥æ“ä½œã€‚
![image.png](./img/_kjzzIE5Zr7q1k8N/1684156756942-50757abd-7245-4033-b544-e8df1ccda19e-859103.png)
æŸ¥æ‰¾çš„æ—¶å€™ï¼Œå…ˆæ ¹æ®ThreadLocalå¯¹è±¡çš„hashå€¼æ‰¾åˆ°å¯¹åº”çš„ä½ç½®ï¼Œç„¶åæ¯”è¾ƒè¯¥æ§½ä½Entryå¯¹è±¡ä¸­çš„keyæ˜¯å¦å’Œgetçš„keyä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´å°±ä¾æ¬¡å¾€åæŸ¥æ‰¾ã€‚

# 14.ThreadLocalMapæ‰©å®¹æœºåˆ¶
ThreadLocalMap çš„æ‰©å®¹æœºåˆ¶å’Œ HashMap ç±»ä¼¼ï¼Œä¹Ÿæ˜¯åœ¨å…ƒç´ æ•°é‡è¾¾åˆ°é˜ˆå€¼ï¼ˆé»˜è®¤ä¸ºæ•°ç»„é•¿åº¦çš„ 2/3ï¼‰æ—¶è¿›è¡Œæ‰©å®¹ã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨ set() æ–¹æ³•ä¸­ï¼Œå¦‚æœå½“å‰å…ƒç´ æ•°é‡å·²ç»è¾¾åˆ°äº†é˜ˆå€¼ï¼Œå°±ä¼šè°ƒç”¨ rehash() æ–¹æ³•ï¼Œrehash()ä¼šå…ˆå»æ¸…ç†è¿‡æœŸçš„Entryï¼Œç„¶åè¿˜è¦æ ¹æ®æ¡ä»¶åˆ¤æ–­size >= threshold - threshold / 4 ä¹Ÿå°±æ˜¯size >= threshold * 3/4æ¥å†³å®šæ˜¯å¦éœ€è¦æ‰©å®¹ï¼š
```java
private void rehash() {
    //æ¸…ç†è¿‡æœŸEntry
    expungeStaleEntries();

    //æ‰©å®¹
    if (size >= threshold - threshold / 4)
        resize();
}

//æ¸…ç†è¿‡æœŸEntry
private void expungeStaleEntries() {
    Entry[] tab = table;
    int len = tab.length;
    for (int j = 0; j < len; j++) {
        Entry e = tab[j];
        if (e != null && e.get() == null)
            expungeStaleEntry(j);
    }
}
```
å‘ç°éœ€è¦æ‰©å®¹æ—¶è°ƒç”¨resize()æ–¹æ³•ï¼Œresize()æ–¹æ³•é¦–å…ˆå°†æ•°ç»„é•¿åº¦ç¿»å€ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„newTabã€‚æ¥ç€éå†æ—§æ•°ç»„oldTabä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œæ•£åˆ—æ–¹æ³•é‡æ–°è®¡ç®—ä½ç½®ï¼Œå¼€æ”¾åœ°å€è§£å†³å†²çªï¼Œç„¶åæ”¾åˆ°æ–°çš„newTabï¼Œéå†å®Œæˆä¹‹åï¼ŒoldTabä¸­æ‰€æœ‰çš„entryæ•°æ®éƒ½å·²ç»æ”¾å…¥åˆ°newTabä¸­äº†ï¼Œç„¶åtableå¼•ç”¨æŒ‡å‘newTab.
![1_æ— æ°´å°.png](./img/_kjzzIE5Zr7q1k8N/1684930309958-230aa573-b12e-4058-8e81-4977fcc8095b-047835.png)
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ–°æ•°ç»„çš„é•¿åº¦å§‹ç»ˆæ˜¯2çš„æ•´æ•°æ¬¡å¹‚ï¼Œå¹¶ä¸”æ‰©å®¹åæ–°æ•°ç»„çš„é•¿åº¦å§‹ç»ˆå¤§äºæ—§æ•°ç»„çš„é•¿åº¦ã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯å“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºçš„ä½ç½®åœ¨æ–°æ•°ç»„ä¸­ä»ç„¶æœ‰æ•ˆã€‚
```java
private void resize() {
    Entry[] oldTab = table;
    int oldLen = oldTab.length;
    int newLen = oldLen * 2;
    Entry[] newTab = new Entry[newLen];
    int count = 0;
    for (int j = 0; j < oldLen; ++j) {
        Entry e = oldTab[j];
        if (e != null) {
            ThreadLocal<?> k = e.get();
            if (k == null) {
                e.value = null; // Help the GC
            } else {
                int h = k.threadLocalHashCode & (newLen - 1);
                while (newTab[h] != null)
                    h = nextIndex(h, newLen);
                newTab[h] = e;
                count++;
            }
        }
    }

    setThreshold(newLen);
    size = count;
    table = newTab;
}
```

# 15.ThreadLocalæ€ä¹ˆè¿›è¡Œçˆ¶å­çº¿ç¨‹é€šä¿¡
åœ¨Javaå¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œçˆ¶å­çº¿ç¨‹ä¹‹é—´çš„æ•°æ®ä¼ é€’å’Œå…±äº«é—®é¢˜ä¸€ç›´æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„è®®é¢˜ã€‚å¦‚æœä¸å¤„ç†å¥½æ•°æ®çš„ä¼ é€’å’Œå…±äº«ï¼Œä¼šå¯¼è‡´å¤šçº¿ç¨‹ç¨‹åºçš„æ€§èƒ½ä¸‹é™æˆ–è€…å‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚ThreadLocalæ˜¯Javaæä¾›çš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥éå¸¸å¥½åœ°è§£å†³çˆ¶å­çº¿ç¨‹æ•°æ®å…±äº«å’Œä¼ é€’çš„é—®é¢˜ã€‚
é‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°é€šä¿¡çš„äº†ï¼Ÿåœ¨Threadç±»ä¸­å­˜åœ¨InheritableThreadLocalå˜é‡ï¼Œç®€å•çš„è¯´å°±æ˜¯ä½¿ç”¨InheritableThreadLocalæ¥è¿›è¡Œä¼ é€’ï¼Œå½“çˆ¶çº¿ç¨‹çš„InheritableThreadLocalä¸ä¸ºç©ºæ—¶ï¼Œå°±ä¼šå°†è¿™ä¸ªå€¼ä¼ åˆ°å½“å‰å­çº¿ç¨‹çš„InheritableThreadLocalã€‚
```java
/**
 * ThreadLocalçˆ¶å­çº¿ç¨‹é€šä¿¡
 * åˆ›å»ºäººï¼šç™¾é‡Œ
 */
public class BaiLiInheritableThreadLocalDemo {
    public static void main(String[] args) throws Exception {
        ThreadLocal threadLocal = new ThreadLocal<>();
        threadLocal.set("threadLocal");

        ThreadLocal inheritableThreadLocal = new InheritableThreadLocal();
        inheritableThreadLocal.set("åˆ†äº« + inheritableThreadLocal");

        Thread t = new Thread(() -> {
            System.out.println("ä¸€é”®ä¸‰è¿ + " + threadLocal.get());
            System.out.println("ä¸€é”®ä¸‰è¿ + " + inheritableThreadLocal.get());
        });
        t.start();
    }
}
```

# 16.è¯´ä¸€ä¸‹ä½ å¯¹Javaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰çš„ç†è§£ï¼Ÿ
Java å†…å­˜æ¨¡å‹ï¼ˆJava Memory Modelï¼‰æ˜¯ä¸€ç§è§„èŒƒï¼Œç”¨äºæè¿° Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰ä¸­å¤šçº¿ç¨‹æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ä¹‹é—´å¦‚ä½•ååŒå·¥ä½œï¼Œå¦‚ä½•å…±äº«æ•°æ®ï¼Œå¹¶ä¿è¯å¤šçº¿ç¨‹çš„æ“ä½œåœ¨å„ä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ã€æœ‰åºæ€§å’ŒåŸå­æ€§ã€‚
å…·ä½“å®šä¹‰å¦‚ä¸‹ï¼š

- æ‰€æœ‰çš„å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ä¸­ã€‚
- æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜ï¼ˆLocal Memoryï¼‰ï¼Œæœ¬åœ°å†…å­˜ä¸­å­˜å‚¨äº†è¯¥çº¿ç¨‹ä»¥è¯»/å†™å…±äº«å˜é‡çš„æ‹·è´å‰¯æœ¬ã€‚
- çº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨æœ¬åœ°å†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ã€‚
- ä¸åŒçš„çº¿ç¨‹ä¹‹é—´æ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹æœ¬åœ°å†…å­˜ä¸­çš„å˜é‡ï¼›çº¿ç¨‹é—´å…±äº«å˜é‡æ—¶ï¼Œé€šè¿‡ä¸»å†…å­˜æ¥å®ç°é€šä¿¡ã€åä½œå’Œä¼ é€’ä¿¡æ¯ã€‚

Javaå†…å­˜æ¨¡å‹çš„æŠ½è±¡å›¾ï¼š
![image.png](./img/_kjzzIE5Zr7q1k8N/1685093188117-fef83191-2a31-45a5-8d7a-b3b87cdb8906-605332.png)
åœ¨è¿™ä¸ªæŠ½è±¡çš„å†…å­˜æ¨¡å‹ä¸­ï¼Œåœ¨ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼ˆå…±äº«å˜é‡çŠ¶æ€å˜æ›´ï¼‰æ—¶ï¼Œä¼šè¿›è¡Œå¦‚ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š

- çº¿ç¨‹AæŠŠåœ¨æœ¬åœ°å†…å­˜æ›´æ–°åçš„å…±äº«å˜é‡å‰¯æœ¬çš„å€¼ï¼Œåˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ã€‚
- çº¿ç¨‹Båœ¨ä½¿ç”¨åˆ°è¯¥å…±äº«å˜é‡æ—¶ï¼Œåˆ°ä¸»å†…å­˜ä¸­å»è¯»å–çº¿ç¨‹Aæ›´æ–°åçš„å…±äº«å˜é‡çš„å€¼ï¼Œå¹¶æ›´æ–°çº¿ç¨‹Bæœ¬åœ°å†…å­˜çš„å€¼ã€‚

# 17.è¯´è¯´ä½ å¯¹åŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§çš„ç†è§£ï¼Ÿ
åŸå­æ€§ã€æœ‰åºæ€§ã€å¯è§æ€§æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­éå¸¸é‡è¦çš„åŸºç¡€æ¦‚å¿µï¼ŒJMMçš„å¾ˆå¤šæŠ€æœ¯éƒ½æ˜¯å›´ç»•ç€è¿™ä¸‰å¤§ç‰¹æ€§å±•å¼€ã€‚

- **åŸå­æ€§**ï¼šæŒ‡ä¸€ä¸ªæ“ä½œæ˜¯ä¸å¯åˆ†å‰²ã€ä¸å¯ä¸­æ–­çš„ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šå—åˆ°å…¶ä»–çº¿ç¨‹çš„å¹²æ‰°ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå°±å…¨ä¸æ‰§è¡Œã€‚å³ä½¿æ˜¯åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªæ“ä½œä¹Ÿæ˜¯åŸå­æ€§çš„æ‰§è¡Œå®Œæˆã€‚

çº¿ç¨‹åˆ‡æ¢ä¼šå¸¦æ¥åŸå­æ€§é—®é¢˜ï¼Œç¤ºä¾‹ï¼š
```java
int count = 0; //1
count++;       //2
int a = count; //3
```
ä¸Šé¢å±•ç¤ºè¯­å¥ä¸­ï¼Œé™¤äº†è¯­å¥1æ˜¯åŸå­æ“ä½œï¼Œå…¶å®ƒä¸¤ä¸ªè¯­å¥éƒ½ä¸æ˜¯åŸå­æ€§æ“ä½œï¼Œä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¯­å¥2
å…¶å®è¯­å¥2åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼ŒåŒ…å«ä¸‰ä¸ªæŒ‡ä»¤æ“ä½œ

- æŒ‡ä»¤ 1ï¼šé¦–å…ˆï¼ŒæŠŠå˜é‡ count ä»å†…å­˜åŠ è½½åˆ° CPU çš„å¯„å­˜å™¨
- æŒ‡ä»¤ 2ï¼šç„¶åï¼Œåœ¨å¯„å­˜å™¨ä¸­æ‰§è¡Œ +1 æ“ä½œ
- æŒ‡ä»¤ 3ï¼šæœ€ç»ˆï¼Œå°†ç»“æœå†™å…¥å†…å­˜

å¯¹äºä¸Šé¢çš„ä¸‰æ¡æŒ‡ä»¤æ¥è¯´ï¼Œå¦‚æœçº¿ç¨‹ A åœ¨æŒ‡ä»¤ 1 æ‰§è¡Œå®Œååšçº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹ A å’Œçº¿ç¨‹ B æŒ‰ç…§ä¸‹å›¾çš„åºåˆ—æ‰§è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šå‘ç°ä¸¤ä¸ªçº¿ç¨‹éƒ½æ‰§è¡Œäº† count+=1 çš„æ“ä½œï¼Œä½†æ˜¯å¾—åˆ°çš„ç»“æœä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ 2ï¼Œè€Œæ˜¯ 1ã€‚
![image.png](./img/_kjzzIE5Zr7q1k8N/1685107945460-001e82b1-2bff-4138-8fa3-c0eb40fe2e73-645108.png)

- **å¯è§æ€§**ï¼šæŒ‡ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹åº”è¯¥æ˜¯ç«‹å³å¯è§çš„ï¼Œç¡®ä¿äº†å„ä¸ªçº¿ç¨‹ä¹‹é—´å¯¹å†…å­˜çŠ¶æ€çš„æ­£ç¡®è§‚å¯Ÿã€‚
- **æœ‰åºæ€§**ï¼šæŒ‡ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„é¡ºåºæ‰§è¡Œã€‚åœ¨å•çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œä»£ç æ‰§è¡Œé¡ºåºä¸ç¼–å†™çš„é¡ºåºä¸€è‡´ã€‚ä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œç”±äºæ—¶é—´ç‰‡è½®æ¢ï¼Œä¸åŒçš„çº¿ç¨‹å¯èƒ½ä¼šäº¤æ›¿æ‰§è¡Œä¸åŒçš„ä»£ç ã€‚

åŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§éƒ½åº”è¯¥æ€ä¹ˆä¿è¯å‘¢ï¼Ÿ

- åŸå­æ€§ï¼šJMMåªèƒ½ä¿è¯åŸºæœ¬çš„åŸå­æ€§ï¼Œå¦‚æœè¦ä¿è¯ä¸€ä¸ªä»£ç å—çš„åŸå­æ€§ï¼Œéœ€è¦ä½¿ç”¨synchronizedã€‚
- å¯è§æ€§ï¼šJavaæ˜¯åˆ©ç”¨volatileå…³é”®å­—æ¥ä¿è¯å¯è§æ€§çš„ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œfinalå’Œsynchronizedä¹Ÿèƒ½ä¿è¯å¯è§æ€§ã€‚
- æœ‰åºæ€§ï¼šsynchronizedæˆ–è€…volatileéƒ½å¯ä»¥ä¿è¯å¤šçº¿ç¨‹ä¹‹é—´æ“ä½œçš„æœ‰åºæ€§ã€‚

# 18.è¯´è¯´ä»€ä¹ˆæ˜¯æŒ‡ä»¤é‡æ’ï¼Ÿ
åœ¨ä¸å½±å“**å•çº¿ç¨‹**ç¨‹åºæ‰§è¡Œç»“æœçš„å‰æä¸‹ï¼Œè®¡ç®—æœºä¸ºäº†æœ€å¤§é™åº¦çš„å‘æŒ¥æœºå™¨æ€§èƒ½ï¼Œå¯¹æœºå™¨æŒ‡ä»¤è¿›è¡Œé‡æ’åºä¼˜åŒ–ã€‚
![image.png](./img/_kjzzIE5Zr7q1k8N/1685601024162-84e82969-c8de-4b97-a605-3ae766c65dad-563866.png)
ä»Javaæºä»£ç åˆ°æœ€ç»ˆå®é™…æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ï¼Œä¼šåˆ†åˆ«ç»å†ä¸‹é¢3ç§é‡æ’åºï¼š
![image.png](./img/_kjzzIE5Zr7q1k8N/1685013568191-65410f78-ce1c-4fa4-899d-3ddfcf6cd599-279842.png)

- ç¼–è¯‘å™¨é‡æ’åºï¼šç¼–è¯‘å™¨åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹é‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚ä¾‹å¦‚æŠŠå˜é‡ç¼“å­˜åˆ°å¯„å­˜å™¨ä¸­ã€æå–å…¬å…±å­è¡¨è¾¾å¼ç­‰ã€‚
- æŒ‡ä»¤çº§é‡æ’åºï¼šå¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚ä¾‹å¦‚ä¹±åºæ‰§è¡Œçš„ Load å’Œ Store æŒ‡ä»¤ã€åˆ†æ”¯é¢„æµ‹ä»¥åŠæŒ‡ä»¤çªå‘ç­‰ã€‚
- å†…å­˜ç³»ç»Ÿé‡æ’åºï¼šç”±äºæ•°æ®è¯»å†™è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°å¤šä¸ªç¼“å†²åŒºï¼Œè¿™ä½¿å¾—åŠ è½½å’Œå­˜å‚¨çš„æ“ä½œçœ‹ä¸Šå»å¯èƒ½æ˜¯ä¹±åºæ‰§è¡Œï¼Œäºæ˜¯éœ€è¦å†…å­˜ç³»ç»Ÿçš„é‡æ’åºã€‚ä¾‹å¦‚å†™å…¥ç¼“å­˜ä¸­çš„æ“ä½œé¡ºåºï¼Œå¯¹äºå…¶ä»–CPUçš„ Cache æ¥è¯´æ˜¯ä¸å¯è§çš„ã€‚

ä»¥åŒé‡æ ¡éªŒé”å•ä¾‹æ¨¡å¼ä¸ºä¾‹å­ï¼ŒSingleton instance=new Singleton()ï¼›å¯¹åº”çš„JVMæŒ‡ä»¤åˆ†ä¸ºä¸‰æ­¥ï¼šåˆ†é…å†…å­˜ç©ºé—´-->åˆå§‹åŒ–å¯¹è±¡--->å¯¹è±¡æŒ‡å‘åˆ†é…çš„å†…å­˜ç©ºé—´ï¼Œä½†æ˜¯ç»è¿‡äº†ç¼–è¯‘å™¨çš„æŒ‡ä»¤é‡æ’åºï¼Œç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥å°±å¯èƒ½ä¼šé‡æ’åºã€‚
![1685099625769-fabca5ab-2a1f-42db-af97-e205aa816e80.png](./img/_kjzzIE5Zr7q1k8N/1685099625769-fabca5ab-2a1f-42db-af97-e205aa816e80-323342.png)
JMMå±äºè¯­è¨€çº§çš„å†…å­˜æ¨¡å‹ï¼Œå®ƒç¡®ä¿åœ¨ä¸åŒçš„ç¼–è¯‘å™¨å’Œä¸åŒçš„å¤„ç†å™¨å¹³å°ä¹‹ä¸Šï¼Œé€šè¿‡ç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºå’ŒæŒ‡ä»¤çº§é‡æ’åºï¼Œä¸ºç¨‹åºå‘˜æä¾›ä¸€è‡´çš„å†…å­˜å¯è§æ€§ä¿è¯ã€‚

# 19.æŒ‡ä»¤é‡æ’æœ‰é™åˆ¶å—ï¼Ÿhappens-beforeäº†è§£å—ï¼Ÿ
æŒ‡ä»¤é‡æ’ä¹Ÿæ˜¯æœ‰ä¸€äº›é™åˆ¶çš„ï¼Œæœ‰ä¸¤ä¸ªè§„åˆ™happens-beforeå’Œas-if-serialæ¥çº¦æŸã€‚
**happens-beforeçš„å®šä¹‰**ï¼š

- å¦‚æœä¸€ä¸ªæ“ä½œhappens-beforeå¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆ**ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœå°†å¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§**ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚
- ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨happens-beforeå…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€Javaå¹³å°çš„å…·ä½“å®ç°å¿…é¡»è¦æŒ‰ç…§ happens-beforeå…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚**åªè¦æ²¡æœ‰æ”¹å˜ç¨‹åºçš„æ‰§è¡Œç»“æœï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨æ€ä¹ˆä¼˜åŒ–éƒ½å¯ä»¥**ã€‚

**happens-beforeçš„å…­å¤§è§„åˆ™**ï¼š
![image.png](./img/_kjzzIE5Zr7q1k8N/1685623658731-6e70f199-601b-468a-9b69-bd21c6769e50-737944.png)

- **ç¨‹åºé¡ºåºè§„åˆ™**ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸ªæ“ä½œï¼Œhappens-beforeäºè¯¥çº¿ç¨‹ä¸­çš„ä»»æ„åç»­æ“ä½œã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1685689521512-add15f92-afab-4fbb-8586-206c2fec7e68-981488.png)
```java
/**
 * é¡ºåºæ€§è§„åˆ™
 * é¡ºåºæ‰§è¡Œæ˜¯é’ˆå¯¹ä»£ç é€»è¾‘è€Œè¨€çš„ï¼Œåœ¨å®é™…æ‰§è¡Œçš„æ—¶å€™å‘ç”ŸæŒ‡ä»¤é‡æ’åºä½†æ˜¯å¹¶æ²¡æœ‰æ”¹å˜æºä»£ç çš„é€»è¾‘ã€‚
 * @author ç™¾é‡Œ
 */
public class BaiLiHappenBeforeDemo {
    public static void main(String[] args) {
        double pi = 3.14; // A
        double r = 1.0; // B
        double area = pi * r * r; // C
        System.out.println(area);
    }
}
```

- **ç›‘è§†å™¨é”è§„åˆ™**ï¼šä¸€ä¸ªunlockæ“ä½œä¹‹å‰å¯¹æŸä¸ªé”çš„lockæ“ä½œå¿…é¡»å‘ç”Ÿåœ¨è¯¥unlockæ“ä½œä¹‹å‰

![image.png](./img/_kjzzIE5Zr7q1k8N/1685689532542-d5394f01-6ee2-4ff9-8b90-3acb3724bb74-213070.png)
```java
import java.util.concurrent.locks.ReentrantLock;

/**
 * é‡æ’é”çš„è¯ï¼Œä¼šå¯¼è‡´é€»è¾‘æ”¹å˜ã€‚
 * @author ç™¾é‡Œ
 */
public class BaiLiHappenBeforeLockDemo {
    public static void main(String[] args) {
        ReentrantLock reentrantLock = new ReentrantLock();
        reentrantLock.lock();
        // TODO 
        reentrantLock.unlock();
        
        reentrantLock.lock();
        // TODO
        reentrantLock.unlock();
    }
}
```

- **volatileå˜é‡è§„åˆ™**ï¼šå¯¹ä¸€ä¸ªvolatileå˜é‡çš„å†™æ“ä½œå¿…é¡»å‘ç”Ÿåœ¨è¯¥å˜é‡çš„è¯»æ“ä½œä¹‹å‰ã€‚
- **ä¼ é€’æ€§è§„åˆ™**ï¼šå¦‚æœA happens-before Bï¼Œä¸”B happens-before Cï¼Œé‚£ä¹ˆA happens-before Cã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1685630315805-21271810-5719-4252-bfdd-4e757bb355cc-480647.png)
ä»å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š

- â€œx=42â€Happens-Before å†™å˜é‡â€œv=trueâ€ï¼Œè¿™æ˜¯è§„åˆ™1çš„å†…å®¹ï¼›
- å†™å˜é‡â€œv=trueâ€Happens-Before è¯»å˜é‡â€œv=trueâ€ï¼Œè¿™æ˜¯è§„åˆ™3çš„å†…å®¹ï¼›
- å†æ ¹æ®è¿™ä¸ªä¼ é€’æ€§è§„åˆ™ï¼Œæˆ‘ä»¬å¾—åˆ°ç»“æœï¼šâ€œx=42â€Happens-Before è¯»å˜é‡â€œv=trueâ€ï¼›

è¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿå¦‚æœçº¿ç¨‹ B è¯»åˆ°äº†â€œv=trueâ€ï¼Œé‚£ä¹ˆçº¿ç¨‹Aè®¾ç½®çš„â€œx=42â€å¯¹çº¿ç¨‹Bæ˜¯å¯è§çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œçº¿ç¨‹Bèƒ½çœ‹åˆ°â€œx == 42â€œã€‚
```java
/**
 * ä¼ é€’æ€§è§„åˆ™
 * @author ç™¾é‡Œ
 */
public class BaiLiHappenBeforeVolatileDemo {
    int x = 0;
    volatile boolean v = false;
    public void writer() {
        x = 42;
        v = true;
    }
    public void reader() {
        if (v == true) {
            System.out.println(x);
        }
    }
}
```

- **çº¿ç¨‹å¯åŠ¨è§„åˆ™**ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.start()ï¼ˆå¯åŠ¨çº¿ç¨‹Bï¼‰ï¼Œé‚£ä¹ˆAçº¿ç¨‹çš„ThreadB.start()æ“ä½œhappens-beforeäºçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1685687580239-7ae3c2cf-271f-46bf-bf70-0b78ceb64f1c-496490.png)
æˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºï¼šçº¿ç¨‹Aå¯åŠ¨çº¿ç¨‹Bä¹‹åï¼Œçº¿ç¨‹Bèƒ½å¤Ÿçœ‹åˆ°çº¿ç¨‹Aåœ¨å¯åŠ¨çº¿ç¨‹Bä¹‹å‰çš„æ“ä½œã€‚

- **çº¿ç¨‹ç»“æŸè§„åˆ™**ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.join()å¹¶æˆåŠŸè¿”å›ï¼Œé‚£ä¹ˆçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œ happens-beforeäº ThreadB.join()æ“ä½œæˆåŠŸè¿”å›åçš„çº¿ç¨‹Aæ“ä½œã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1685691885096-1f29745c-b666-4d1c-bb2c-382e8d9a8bd9-444156.png)
**åœ¨Javaè¯­è¨€é‡Œé¢ï¼ŒHappens-Beforeçš„è¯­ä¹‰æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å¯è§æ€§ï¼ŒA Happens-Before B æ„å‘³ç€Aäº‹ä»¶å¯¹Bäº‹ä»¶æ¥è¯´æ˜¯å¯è§çš„ï¼Œå¹¶ä¸”æ— è®ºAäº‹ä»¶å’ŒBäº‹ä»¶æ˜¯å¦å‘ç”Ÿåœ¨åŒä¸€ä¸ªçº¿ç¨‹é‡Œã€‚**

# 20.as-if-serialåˆæ˜¯ä»€ä¹ˆï¼Ÿå•çº¿ç¨‹çš„ç¨‹åºä¸€å®šæ˜¯é¡ºåºçš„å—ï¼Ÿ
as-if-serialæ˜¯æŒ‡æ— è®ºå¦‚ä½•é‡æ’åºéƒ½ä¸ä¼šå½±å“å•çº¿ç¨‹ç¨‹åºçš„æ‰§è¡Œç»“æœã€‚è¿™ä¸ªåŸåˆ™çš„æ ¸å¿ƒæ€æƒ³æ˜¯ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ç­‰å„ä¸ªå±‚é¢çš„ä¼˜åŒ–ï¼Œä¸èƒ½æ”¹å˜ç¨‹åºæ‰§è¡Œçš„æ„ä¹‰ã€‚
![image.png](./img/_kjzzIE5Zr7q1k8N/1685017554575-0d736385-a280-4a51-8353-d43b0ccdfee2-264965.png)
Aå’ŒCä¹‹é—´å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ï¼ŒåŒæ—¶Bå’ŒCä¹‹é—´ä¹Ÿå­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»ã€‚å› æ­¤åœ¨æœ€ç»ˆæ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ä¸­ï¼ŒCä¸èƒ½è¢«é‡æ’åºåˆ°Aå’ŒBçš„å‰é¢ï¼ˆCæ’åˆ°Aå’ŒBçš„å‰é¢ï¼Œç¨‹åºçš„ç»“æœå°†ä¼šè¢«æ”¹å˜ï¼‰ã€‚ä½†Aå’ŒBä¹‹é—´æ²¡æœ‰æ•°æ®ä¾èµ–å…³ç³»ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯ä»¥é‡æ’åºAå’ŒBä¹‹é—´çš„æ‰§è¡Œé¡ºåºã€‚
æ‰€ä»¥æœ€ç»ˆï¼Œç¨‹åºå¯èƒ½ä¼šæœ‰ä¸¤ç§æ‰§è¡Œé¡ºåºï¼š
![image.png](./img/_kjzzIE5Zr7q1k8N/1685017119701-065df96d-c0b0-4353-ad5d-9871e3bb8a4b-905816.png)

# 21.volatileå®ç°åŸç†äº†è§£å—ï¼Ÿ
volatileæœ‰ä¸¤ä¸ªä½œç”¨ï¼Œä¿è¯å¯è§æ€§å’Œæœ‰åºæ€§ã€‚
å¯è§æ€§ï¼šå½“ä¸€ä¸ªå˜é‡è¢«å£°æ˜ä¸º volatile æ—¶ï¼Œå®ƒä¼šå‘Šè¯‰ç¼–è¯‘å™¨å’ŒCPUå°†è¯¥å˜é‡å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼Œè€Œä¸æ˜¯çº¿ç¨‹çš„æœ¬åœ°å†…å­˜ä¸­ã€‚å³æ¯ä¸ªçº¿ç¨‹è¯»å–çš„éƒ½æ˜¯ä¸»å†…å­˜ä¸­æœ€æ–°çš„å€¼ï¼Œé¿å…äº†å¤šçº¿ç¨‹å¹¶å‘ä¸‹çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚
![image.png](./img/_kjzzIE5Zr7q1k8N/1685018954216-3eb91ae1-6a22-4b9b-9abe-3a1adc6b4647-292998.png)
æœ‰åºæ€§ï¼šé‡æ’åºå¯ä»¥åˆ†ä¸ºç¼–è¯‘å™¨é‡æ’åºå’Œå¤„ç†å™¨é‡æ’åºï¼Œvalatileä¿è¯æœ‰åºæ€§ï¼Œå°±æ˜¯é€šè¿‡åˆ†åˆ«é™åˆ¶è¿™ä¸¤ç§ç±»å‹çš„é‡æ’åºã€‚
![image.png](./img/_kjzzIE5Zr7q1k8N/1685019878800-bb1a417f-da7c-44b7-8f7b-120675374482-847271.png)
ä¸ºäº†å®ç°volatileçš„å†…å­˜è¯­ä¹‰ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æŒ‡ä»¤åºåˆ—ä¸­æ’å…¥å†…å­˜å±éšœæ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚

1. åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ªStoreStoreå±éšœ
2. åœ¨æ¯ä¸ªvolatileå†™æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªStoreLoadå±éšœ
3. åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªLoadLoadå±éšœ
4. åœ¨æ¯ä¸ªvolatileè¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ªLoadStoreå±éšœ

![image.png](./img/_kjzzIE5Zr7q1k8N/1685021564855-58e38bb9-df5c-4dfd-9bb2-eb82fda308d8-643936.png)

# 22.synchronizedç”¨è¿‡å—ï¼Ÿæ€ä¹ˆä½¿ç”¨ï¼Ÿ
synchronizedç»å¸¸ç”¨çš„ï¼Œç”¨æ¥ä¿è¯ä»£ç çš„åŸå­æ€§ã€‚
synchronizedä¸»è¦æœ‰ä¸‰ç§ç”¨æ³•ï¼š

- **ä¿®é¥°å®ä¾‹æ–¹æ³•**: ä½œç”¨äºå½“å‰å¯¹è±¡å®ä¾‹åŠ é”ï¼Œè¿›å…¥åŒæ­¥ä»£ç å‰è¦è·å¾—å½“å‰å¯¹è±¡å®ä¾‹çš„é”ã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1686039061987-ec3888ac-e3ec-43c2-91c6-614c9b3f9785-683052.png)

- **ä¿®é¥°é™æ€æ–¹æ³•**ï¼šç»™å½“å‰ç±»åŠ é”ï¼Œåœ¨åŒä¸€æ—¶é—´å†…ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰è¯¥ç±»å¯¹åº”çš„ Class å¯¹è±¡çš„é”ï¼Œå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾…é”çš„é‡Šæ”¾æ‰èƒ½ç»§ç»­æ‰§è¡Œè¯¥é™æ€æ–¹æ³•ã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1686039094092-c6337aba-5a27-40b7-ae30-d12207d63046-875614.png)

- **ä¿®é¥°ä»£ç å—** ï¼šæŒ‡å®šä¸€ä¸ªåŒæ­¥é”å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¯ä»¥æ˜¯å…·ä½“çš„Objectæˆ–è€…æ˜¯ç±».classã€‚åœ¨åŒä¸€æ—¶é—´å†…ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰è¯¥åŒæ­¥é”å¯¹è±¡çš„é”ï¼Œå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾…é”çš„é‡Šæ”¾æ‰èƒ½ç»§ç»­æ‰§è¡Œè¯¥ä»£ç å—ã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1686039154106-5707d8bf-b308-4c6d-a61e-166b79ab0904-097146.png)
**æ³¨æ„äº‹é¡¹ï¼š**

- **ä¿®é¥°å®ä¾‹æ–¹æ³•**ï¼šä¸åŒçš„å¯¹è±¡å®ä¾‹ä¹‹é—´å¹¶ä¸ä¼šäº’ç›¸å½±å“ï¼Œå®ƒä»¬çš„é”æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚å› æ­¤ï¼Œå¦‚æœä¸åŒçš„çº¿ç¨‹åœ¨ä¸åŒçš„å¯¹è±¡å®ä¾‹ä¸Šæ‰§è¡ŒåŒä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œå®ƒä»¬ä¹‹é—´å¹¶ä¸ä¼šå› ä¸ºå…±äº«å˜é‡è€Œäº§ç”Ÿäº’æ–¥çš„æ•ˆæœã€‚
- **ä¿®é¥°é™æ€æ–¹æ³•**ï¼šåº”è¯¥å°½é‡é¿å…æŒæœ‰é”çš„æ—¶é—´è¿‡é•¿ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´å…¶ä»–çº¿ç¨‹é•¿æ—¶é—´ç­‰å¾…ï¼Œä»è€Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚åŒæ—¶ï¼Œä¹Ÿè¦æ³¨æ„é¿å…æ­»é”çš„æƒ…å†µã€‚
- **ä¿®é¥°ä»£ç å—**ï¼šåŒæ­¥é”å¹¶ä¸æ˜¯å¯¹æ•´ä¸ªä»£ç å—è¿›è¡ŒåŠ é”ï¼Œè€Œæ˜¯å¯¹åŒæ­¥é”å¯¹è±¡è¿›è¡ŒåŠ é”ã€‚å› æ­¤ï¼Œå¦‚æœåœ¨ä¸åŒçš„ä»£ç å—ä¸­ä½¿ç”¨äº†ç›¸åŒçš„åŒæ­¥é”å¯¹è±¡ï¼Œå®ƒä»¬ä¹‹é—´ä¹Ÿä¼šäº§ç”Ÿäº’æ–¥çš„æ•ˆæœã€‚è€Œå¦‚æœä½¿ç”¨ä¸åŒçš„åŒæ­¥é”å¯¹è±¡ï¼Œåˆ™å®ƒä»¬ä¹‹é—´å¹¶ä¸ä¼šäº§ç”Ÿäº’æ–¥çš„æ•ˆæœã€‚

# 23.synchronizedçš„å®ç°åŸç†ï¼Ÿ
æˆ‘ä»¬ä½¿ç”¨synchronizedçš„æ—¶å€™ï¼Œå‘ç°ä¸ç”¨è‡ªå·±å»lockå’Œunlockï¼Œæ˜¯å› ä¸ºJVMå¸®æˆ‘ä»¬æŠŠè¿™ä¸ªäº‹æƒ…åšäº†ã€‚

1. **synchronizedä¿®é¥°ä»£ç å—æ—¶**ï¼ŒJVMé‡‡ç”¨monitorenterã€monitorexitä¸¤ä¸ªæŒ‡ä»¤æ¥å®ç°åŒæ­¥ï¼Œmonitorenter æŒ‡ä»¤æŒ‡å‘åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œ monitorexit æŒ‡ä»¤åˆ™æŒ‡å‘åŒæ­¥ä»£ç å—çš„ç»“æŸä½ç½®ã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1685710049528-c9e45125-066c-4097-812d-afa45e11517d-015165.png)
```java
/**
 * @author ç™¾é‡Œ
 */
public class BaiLiSyncDemo {
    public void main(String[] args) {
        synchronized (this) {
            int a = 1;
        }
    }
}
```
```java
public void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC
    Code:
      stack=2, locals=5, args_size=2
         0: aload_0
         1: dup
         2: astore_2
         3: monitorenter
         4: iconst_1
         5: istore_3
         6: aload_2
         7: monitorexit
         8: goto          18
        11: astore        4
        13: aload_2
        14: monitorexit
        15: aload         4
        17: athrow
        18: return
```

2. **synchronizedä¿®é¥°åŒæ­¥æ–¹æ³•æ—¶**ï¼ŒJVMé‡‡ç”¨ACC_SYNCHRONIZEDæ ‡è®°ç¬¦æ¥å®ç°åŒæ­¥ï¼Œè¿™ä¸ªæ ‡è¯†æŒ‡æ˜äº†è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ã€‚åŒæ ·å¯ä»¥å†™æ®µä»£ç åç¼–è¯‘çœ‹ä¸€ä¸‹ã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1685710074450-0caf7ec9-28c2-4ab6-9c24-827f939f3f22-723267.png)
```java
/**
 * @author ç™¾é‡Œ
 */
public class BaiLiSyncDemo {
    public synchronized void main(String[] args) {
        int a = 1;
    }
}
```
**synchronizedé”ä½çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ**
å®ä¾‹å¯¹è±¡ç»“æ„é‡Œæœ‰å¯¹è±¡å¤´ï¼Œå¯¹è±¡å¤´é‡Œé¢æœ‰ä¸€å—ç»“æ„å«Mark Wordï¼ŒMark WordæŒ‡é’ˆæŒ‡å‘äº†monitorã€‚
æ‰€è°“çš„Monitorå…¶å®æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¸ºå†…éƒ¨é”æˆ–è€…Monitoré”ã€‚
monitorenterã€monitorexitæˆ–è€…ACC_SYNCHRONIZEDéƒ½æ˜¯åŸºäºMonitorå®ç°çš„ã€‚
**åç¼–è¯‘classæ–‡ä»¶æ–¹æ³•ï¼š**
åç¼–è¯‘ä¸€æ®µsynchronizedä¿®é¥°ä»£ç å—ä»£ç ï¼Œjavap -c -s -v -l ***.classï¼Œå¯ä»¥çœ‹åˆ°ç›¸åº”çš„å­—èŠ‚ç æŒ‡ä»¤ã€‚

# 24.synchronizedçš„å¯è§æ€§ï¼Œæœ‰åºæ€§ï¼Œå¯é‡å…¥æ€§æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ
**synchronizedæ€ä¹ˆä¿è¯å¯è§æ€§ï¼Ÿ**

- çº¿ç¨‹åŠ é”å‰ï¼Œå°†æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼ï¼Œä»è€Œä½¿ç”¨å…±äº«å˜é‡æ—¶éœ€è¦ä»ä¸»å†…å­˜ä¸­é‡æ–°è¯»å–æœ€æ–°çš„å€¼ã€‚
- çº¿ç¨‹åŠ é”åï¼Œå…¶å®ƒçº¿ç¨‹æ— æ³•è·å–ä¸»å†…å­˜ä¸­çš„å…±äº«å˜é‡ã€‚
- çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡çš„æœ€æ–°å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ã€‚

**synchronizedæ€ä¹ˆä¿è¯æœ‰åºæ€§ï¼Ÿ**
synchronizedåŒæ­¥çš„ä»£ç å—ï¼Œå…·æœ‰æ’ä»–æ€§ï¼Œä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰ï¼Œæ‰€ä»¥synchronizedä¿è¯åŒä¸€æ—¶åˆ»ï¼Œä»£ç æ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ã€‚
å› ä¸ºas-if-serialè¯­ä¹‰çš„å­˜åœ¨ï¼Œå•çº¿ç¨‹çš„ç¨‹åºèƒ½ä¿è¯æœ€ç»ˆç»“æœæ˜¯æœ‰åºçš„ï¼Œä½†æ˜¯ä¸ä¿è¯ä¸ä¼šæŒ‡ä»¤é‡æ’ã€‚
æ‰€ä»¥synchronizedä¿è¯çš„æœ‰åºæ˜¯æ‰§è¡Œç»“æœçš„æœ‰åºæ€§ï¼Œè€Œä¸æ˜¯é˜²æ­¢æŒ‡ä»¤é‡æ’çš„æœ‰åºæ€§ã€‚
**synchronizedæ€ä¹ˆå®ç°å¯é‡å…¥çš„ï¼Ÿ**
synchronized æ˜¯å¯é‡å…¥é”ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå…è®¸ä¸€ä¸ªçº¿ç¨‹äºŒæ¬¡è¯·æ±‚è‡ªå·±æŒæœ‰å¯¹è±¡é”çš„ä¸´ç•Œèµ„æºï¼Œè¿™ç§æƒ…å†µç§°ä¸ºå¯é‡å…¥é”ã€‚
ä¹‹æ‰€ä»¥æ˜¯å¯é‡å…¥çš„ã€‚æ˜¯å› ä¸º synchronized é”å¯¹è±¡æœ‰ä¸ªè®¡æ•°å™¨ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚æˆåŠŸåï¼ŒJVMä¼šè®°ä¸‹æŒæœ‰é”çš„çº¿ç¨‹ï¼Œå¹¶å°†è®¡æ•°å™¨è®¡ä¸º1ã€‚æ­¤æ—¶å…¶ä»–çº¿ç¨‹è¯·æ±‚è¯¥é”ï¼Œåˆ™å¿…é¡»ç­‰å¾…ã€‚è€Œè¯¥æŒæœ‰é”çš„çº¿ç¨‹å¦‚æœå†æ¬¡è¯·æ±‚è¿™ä¸ªé”ï¼Œå°±å¯ä»¥å†æ¬¡æ‹¿åˆ°è¿™ä¸ªé”ï¼ŒåŒæ—¶è®¡æ•°å™¨ä¼šé€’å¢ã€‚
å½“çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œè®¡æ•°å™¨ä¼šé€’å‡ï¼Œç›´åˆ°è®¡æ•°å™¨ä¸º0æ‰é‡Šæ”¾è¯¥é”ã€‚

# 25.è¯´è¯´synchronizedå’ŒReentrantLockçš„åŒºåˆ«
å¯ä»¥ä»**é”çš„å®ç°**ã€**æ€§èƒ½**ã€**åŠŸèƒ½ç‰¹ç‚¹**ç­‰å‡ ä¸ªç»´åº¦å»å›ç­”è¿™ä¸ªé—®é¢˜ï¼š

- **é”çš„å®ç°**ï¼š synchronizedæ˜¯Javaè¯­è¨€çš„å…³é”®å­—ï¼ŒåŸºäºJVMå®ç°ã€‚è€ŒReentrantLockæ˜¯åŸºäºJDKçš„APIå±‚é¢å®ç°çš„ï¼ˆä¸€èˆ¬æ˜¯lock()å’Œunlock()æ–¹æ³•é…åˆtry/finallyè¯­å¥å—æ¥å®Œæˆã€‚ï¼‰
- **æ€§èƒ½**ï¼š åœ¨JDK1.6é”ä¼˜åŒ–ä»¥å‰ï¼Œsynchronizedçš„æ€§èƒ½æ¯”ReenTrantLockå·®å¾ˆå¤šã€‚ä½†æ˜¯JDK6å¼€å§‹ï¼Œå¢åŠ äº†é€‚åº”æ€§è‡ªæ—‹ã€é”æ¶ˆé™¤ç­‰ï¼Œä¸¤è€…æ€§èƒ½å°±å·®ä¸å¤šäº†ã€‚
- **åŠŸèƒ½ç‰¹ç‚¹**ï¼š ReentrantLock æ¯” synchronized å¤šäº†ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œå¦‚ç­‰å¾…å¯ä¸­æ–­ã€å¯å®ç°å…¬å¹³é”ã€å¯å®ç°é€‰æ‹©æ€§é€šçŸ¥ã€‚
      - ReentrantLockæä¾›äº†ä¸€ç§èƒ½å¤Ÿä¸­æ–­ç­‰å¾…é”çš„çº¿ç¨‹çš„æœºåˆ¶ï¼Œé€šè¿‡lock.lockInterruptibly()æ¥å®ç°è¿™ä¸ªæœºåˆ¶
      - ReentrantLockå¯ä»¥æŒ‡å®šæ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚è€Œsynchronizedåªèƒ½æ˜¯éå…¬å¹³é”ã€‚æ‰€è°“çš„å…¬å¹³é”å°±æ˜¯å…ˆç­‰å¾…çš„çº¿ç¨‹å…ˆè·å¾—é”ã€‚
      - synchronizedä¸wait()å’Œnotify()/notifyAll()æ–¹æ³•ç»“åˆå®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶ï¼›ReentrantLockç±»å€ŸåŠ©Conditionæ¥å£ä¸newCondition()æ–¹æ³•å®ç°ã€‚
      - ReentrantLockéœ€è¦æ‰‹å·¥å£°æ˜æ¥åŠ é”å’Œé‡Šæ”¾é”ï¼Œä¸€èˆ¬è·Ÿfinallyé…åˆé‡Šæ”¾é”ã€‚è€Œsynchronizedä¸ç”¨æ‰‹åŠ¨é‡Šæ”¾é”ã€‚

ä¸‹é¢çš„è¡¨æ ¼åˆ—å‡ºäº†ä¸¤ç§é”ä¹‹é—´çš„åŒºåˆ«ï¼š
![image.png](./img/_kjzzIE5Zr7q1k8N/1685712027520-59fe30bc-d455-432c-970a-e6afb71bd786-243030.png)

# 26.ReentrantLockå®ç°åŸç†ï¼Ÿ
ReentrantLockæ˜¯ä¸€ç§å¯é‡å…¥çš„æ’å®ƒé”ï¼Œä¸»è¦ç”¨æ¥è§£å†³å¤šçº¿ç¨‹å¯¹å…±äº«èµ„æºç«äº‰çš„é—®é¢˜ï¼›å®ƒæä¾›äº†æ¯”synchronizedå…³é”®å­—æ›´åŠ çµæ´»çš„é”æœºåˆ¶ã€‚å…¶å®ç°åŸç†ä¸»è¦æ¶‰åŠä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š

- **åŸºæœ¬ç»“æ„**

ReentrantLockå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªSyncå¯¹è±¡ï¼ˆAbstractQueuedSynchronizerç±»çš„å­ç±»ï¼‰ï¼ŒSyncæŒæœ‰é”ã€ç­‰å¾…é˜Ÿåˆ—ç­‰çŠ¶æ€ä¿¡æ¯ï¼Œå®é™…ä¸Š ReentrantLockçš„å¤§éƒ¨åˆ†åŠŸèƒ½éƒ½æ˜¯ç”±Syncæ¥å®ç°çš„ã€‚

- **åŠ é”è¿‡ç¨‹**

å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ReentrantLockçš„lock()æ–¹æ³•æ—¶ï¼Œä¼šå…ˆå°è¯•CASæ“ä½œè·å–é”ï¼Œå¦‚æœæˆåŠŸåˆ™è¿”å›ï¼›å¦åˆ™ï¼Œçº¿ç¨‹ä¼šè¢«æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å”¤é†’é‡æ–°å°è¯•è·å–é”ã€‚
å¦‚æœä¸€ä¸ªçº¿ç¨‹å·²ç»æŒæœ‰äº†é”ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥é‡å…¥è¿™ä¸ªé”ï¼Œå³ç»§ç»­è·å–è¯¥é”è€Œä¸ä¼šè¢«é˜»å¡ã€‚ReentrantLocké€šè¿‡ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨æ¥å®ç°é‡å…¥é”åŠŸèƒ½ï¼Œæ¯æ¬¡é‡å…¥è®¡æ•°å™¨åŠ 1ï¼Œæ¯æ¬¡é‡Šæ”¾é”è®¡æ•°å™¨å‡1ï¼Œå½“è®¡æ•°å™¨ä¸º0æ—¶ï¼Œé”è¢«é‡Šæ”¾ã€‚

- **è§£é”è¿‡ç¨‹**

å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ReentrantLockçš„unlock()æ–¹æ³•æ—¶ï¼Œä¼šå°†è®¡æ•°å™¨å‡1ï¼Œå¦‚æœè®¡æ•°å™¨å˜ä¸ºäº†0ï¼Œåˆ™é”è¢«å®Œå…¨é‡Šæ”¾ã€‚å¦‚æœè®¡æ•°å™¨è¿˜å¤§äº0ï¼Œåˆ™è¡¨ç¤ºæœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨ç­‰å¾…è¯¥é”ï¼Œæ­¤æ—¶ä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªçº¿ç¨‹æ¥è·å–é”ã€‚
**æ€»ç»“**ï¼š
ReentrantLockçš„å®ç°åŸç†ä¸»è¦æ˜¯åŸºäºCASæ“ä½œå’Œç­‰å¾…é˜Ÿåˆ—æ¥å®ç°ã€‚å®ƒé€šè¿‡Syncå¯¹è±¡æ¥ç»´æŠ¤é”çš„çŠ¶æ€ï¼Œæ”¯æŒé‡å…¥é”å’Œå…¬å¹³é”ç­‰ç‰¹æ€§ï¼Œæä¾›äº†æ¯”synchronizedæ›´åŠ çµæ´»çš„é”æœºåˆ¶ï¼Œæ˜¯Javaå¹¶å‘ç¼–ç¨‹ä¸­å¸¸ç”¨çš„åŒæ­¥å·¥å…·ä¹‹ä¸€ã€‚

# 27.ReentrantLockæ€ä¹ˆå®ç°å…¬å¹³é”çš„ï¼Ÿ
ReentrantLockå¯ä»¥é€šè¿‡æ„é€ å‡½æ•°çš„å‚æ•°æ¥æ§åˆ¶é”çš„å…¬å¹³æ€§ï¼Œå¦‚æœä¼ å…¥ trueï¼Œå°±è¡¨ç¤ºè¯¥é”æ˜¯å…¬å¹³çš„ï¼›å¦‚æœä¼ å…¥ falseï¼Œå°±è¡¨ç¤ºè¯¥é”æ˜¯ä¸å…¬å¹³çš„ã€‚
new ReentrantLock()æ„é€ å‡½æ•°é»˜è®¤åˆ›å»ºçš„æ˜¯éå…¬å¹³é” NonfairSync
![image.png](./img/_kjzzIE5Zr7q1k8N/1685712916526-6606693e-9979-4e13-8efb-2de123bacf66-716912.png)
åŒæ—¶ä¹Ÿå¯ä»¥åœ¨åˆ›å»ºé”æ„é€ å‡½æ•°ä¸­ä¼ å…¥å…·ä½“å‚æ•°åˆ›å»ºå…¬å¹³é” FairSync
![image.png](./img/_kjzzIE5Zr7q1k8N/1685712937169-30e4d4e3-52be-4822-8f1b-ccdec6fc8f42-029995.png)
FairSyncã€NonfairSync ä»£è¡¨å…¬å¹³é”å’Œéå…¬å¹³é”ï¼Œä¸¤è€…éƒ½æ˜¯ ReentrantLock é™æ€å†…éƒ¨ç±»ï¼Œåªä¸è¿‡å®ç°ä¸åŒé”è¯­ä¹‰ã€‚
éå…¬å¹³é”å’Œå…¬å¹³é”çš„åŒºåˆ«ï¼š

- éå…¬å¹³é”åœ¨è°ƒç”¨ lock åï¼Œé¦–å…ˆå°±ä¼šè°ƒç”¨ CAS è¿›è¡Œä¸€æ¬¡æŠ¢é”ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™æ°å·§é”æ²¡æœ‰è¢«å ç”¨ï¼Œé‚£ä¹ˆç›´æ¥å°±è·å–åˆ°é”è¿”å›äº†ã€‚
- éå…¬å¹³é”åœ¨ CAS å¤±è´¥åï¼Œå’Œå…¬å¹³é”ä¸€æ ·éƒ½ä¼šè¿›å…¥åˆ° tryAcquire æ–¹æ³•ï¼Œåœ¨ tryAcquire æ–¹æ³•ä¸­ï¼Œå¦‚æœå‘ç°é”è¿™ä¸ªæ—¶å€™è¢«é‡Šæ”¾äº†ï¼ˆstate == 0ï¼‰ï¼Œéå…¬å¹³é”ä¼šç›´æ¥ CAS æŠ¢é”ï¼Œä½†æ˜¯å…¬å¹³é”ä¼šåˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—æ˜¯å¦æœ‰çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå¦‚æœæœ‰åˆ™ä¸å»æŠ¢é”ï¼Œä¹–ä¹–æ’åˆ°åé¢ã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1686113867113-dba3fede-7ce8-47d8-9cc7-7d45897e2fdf-275938.png)

# 28.ä»€ä¹ˆæ˜¯CAS? 
CASå«åšCompareAndSwapï¼Œæ¯”è¾ƒå¹¶äº¤æ¢ï¼Œä¸»è¦æ˜¯é€šè¿‡å¤„ç†å™¨çš„æŒ‡ä»¤æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§çš„ã€‚
CAS æ“ä½œåŒ…å«ä¸‰ä¸ªå‚æ•°ï¼šå…±äº«å˜é‡çš„å†…å­˜åœ°å€ï¼ˆVï¼‰ã€é¢„æœŸåŸå€¼ï¼ˆAï¼‰å’Œæ–°å€¼ï¼ˆBï¼‰ï¼Œå½“ä¸”ä»…å½“å†…å­˜åœ°å€ V çš„å€¼ç­‰äº A æ—¶ï¼Œæ‰å°† V çš„å€¼ä¿®æ”¹ä¸º Bï¼›å¦åˆ™ï¼Œä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œã€‚
åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ CAS æ“ä½œå¯ä»¥ç¡®ä¿å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹æŸä¸ªå˜é‡æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤ŸæˆåŠŸä¿®æ”¹ã€‚å…¶ä»–çº¿ç¨‹éœ€è¦é‡è¯•æˆ–è€…ç­‰å¾…ã€‚è¿™æ ·å°±é¿å…äº†ä¼ ç»Ÿé”æœºåˆ¶ä¸­çš„é”ç«äº‰å’Œæ­»é”ç­‰é—®é¢˜ï¼Œæé«˜äº†ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ã€‚

# 29.CASå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ
CASçš„ç»å…¸ä¸‰å¤§é—®é¢˜ï¼š
![image.png](./img/_kjzzIE5Zr7q1k8N/1686063228535-2dfe1624-9882-4ac5-b58c-45b9d058e2e5-950555.png)
**ABAé—®é¢˜**
ABA é—®é¢˜æ˜¯æŒ‡ä¸€ä¸ªå˜é‡ä»Aå˜æˆBï¼Œå†ä»Bå˜æˆAï¼Œè¿™æ ·çš„æ“ä½œåºåˆ—å¯èƒ½ä¼šè¢«CASæ“ä½œè¯¯åˆ¤ä¸ºæœªè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡ã€‚ä¾‹å¦‚çº¿ç¨‹Aè¯»å–äº†æŸä¸ªå˜é‡çš„å€¼ä¸º Aï¼Œç„¶åè¢«æŒ‚èµ·ï¼Œçº¿ç¨‹Bä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ä¸ºBï¼Œç„¶ååˆä¿®æ”¹å›äº†Aï¼Œæ­¤æ—¶çº¿ç¨‹Aæ¢å¤æ‰§è¡Œï¼Œè¿›è¡ŒCASæ“ä½œï¼Œæ­¤æ—¶ä»ç„¶å¯ä»¥æˆåŠŸï¼Œå› ä¸ºæ­¤æ—¶å˜é‡çš„å€¼è¿˜æ˜¯Aã€‚
æ€ä¹ˆè§£å†³ABAé—®é¢˜ï¼Ÿ

- åŠ ç‰ˆæœ¬å·

æ¯æ¬¡ä¿®æ”¹å˜é‡ï¼Œéƒ½åœ¨è¿™ä¸ªå˜é‡çš„ç‰ˆæœ¬å·ä¸ŠåŠ 1ï¼Œè¿™æ ·ï¼ŒåˆšåˆšA->B->Aï¼Œè™½ç„¶Açš„å€¼æ²¡å˜ï¼Œä½†æ˜¯å®ƒçš„ç‰ˆæœ¬å·å·²ç»å˜äº†ï¼Œå†åˆ¤æ–­ç‰ˆæœ¬å·å°±ä¼šå‘ç°æ­¤æ—¶çš„Aå·²ç»è¢«æ”¹è¿‡äº†ã€‚
æ¯”å¦‚ä½¿ç”¨JDK5ä¸­çš„**AtomicStampedReferenceç±»**æˆ–JDK8ä¸­çš„**LongAdderç±»**ã€‚è¿™äº›åŸå­ç±»å‹ä¸ä»…åŒ…å«æ•°æ®æœ¬èº«ï¼Œè¿˜åŒ…å«ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ¯æ¬¡è¿›è¡Œæ“ä½œæ—¶éƒ½ä¼šæ›´æ–°ç‰ˆæœ¬å·ï¼Œåªæœ‰å½“ç‰ˆæœ¬å·å’ŒæœŸæœ›å€¼éƒ½ç›¸ç­‰æ—¶æ‰èƒ½æ‰§è¡Œæ›´æ–°ï¼Œè¿™æ ·å¯ä»¥é¿å… ABA é—®é¢˜çš„å½±å“ã€‚
**å¾ªç¯æ€§èƒ½å¼€é”€**
è‡ªæ—‹CASï¼Œå¦‚æœä¸€ç›´å¾ªç¯æ‰§è¡Œï¼Œä¸€ç›´ä¸æˆåŠŸï¼Œä¼šç»™CPUå¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€ã€‚
æ€ä¹ˆè§£å†³å¾ªç¯æ€§èƒ½å¼€é”€é—®é¢˜ï¼Ÿ
å¯ä»¥ä½¿ç”¨è‡ªé€‚åº”è‡ªæ—‹é”ï¼Œå³åœ¨å¤šæ¬¡æ“ä½œå¤±è´¥åé€æ¸åŠ é•¿è‡ªæ—‹æ—¶é—´æˆ–è€…æ”¾å¼ƒè‡ªæ—‹é”è½¬ä¸ºé˜»å¡é”ï¼›
**åªèƒ½ä¿è¯ä¸€ä¸ªå˜é‡çš„åŸå­æ“ä½œ**
CAS ä¿è¯çš„æ˜¯å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œæ“ä½œçš„åŸå­æ€§ï¼Œå¦‚æœéœ€è¦å¯¹å¤šä¸ªå˜é‡è¿›è¡Œå¤åˆæ“ä½œï¼ŒCAS æ“ä½œå°±æ— æ³•ä¿è¯æ•´ä¸ªæ“ä½œçš„åŸå­æ€§ã€‚
æ€ä¹ˆè§£å†³åªèƒ½ä¿è¯ä¸€ä¸ªå˜é‡çš„åŸå­æ“ä½œé—®é¢˜ï¼Ÿ

- **å¯ä»¥ä½¿ç”¨é”æœºåˆ¶æ¥ä¿è¯æ•´ä¸ªå¤åˆæ“ä½œçš„åŸå­æ€§**ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ **synchronized å…³é”®å­—**æˆ– **ReentrantLock ç±»**æ¥ä¿è¯å¤šä¸ªå˜é‡çš„å¤åˆæ“ä½œçš„åŸå­æ€§ã€‚åœ¨é”çš„ä½œç”¨ä¸‹ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œå¤åˆæ“ä½œï¼Œå…¶ä»–çº¿ç¨‹éœ€è¦ç­‰å¾…è¯¥çº¿ç¨‹é‡Šæ”¾é”åæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚è¿™æ ·å°±å¯ä»¥ä¿è¯æ•´ä¸ªæ“ä½œçš„åŸå­æ€§äº†ã€‚
- **å¯ä»¥ä½¿ç”¨ç±»ä¼¼äºäº‹åŠ¡çš„æ–¹å¼æ¥ä¿è¯å¤šä¸ªå˜é‡çš„å¤åˆæ“ä½œçš„åŸå­æ€§**ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨**AtomicReference ç±»**ï¼Œå¯ä»¥å°†å¤šä¸ªå˜é‡å°è£…åˆ°ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œé€šè¿‡ CAS æ“ä½œæ›´æ–°æ•´ä¸ªå¯¹è±¡ï¼Œä»è€Œä¿è¯å¤šä¸ªå˜é‡çš„å¤åˆæ“ä½œçš„åŸå­æ€§ã€‚åªæœ‰å½“æ•´ä¸ªå¯¹è±¡çš„å€¼å’ŒæœŸæœ›å€¼éƒ½ç›¸ç­‰æ—¶æ‰ä¼šæ‰§è¡Œæ›´æ–°æ“ä½œã€‚

# 30.Javaå¤šçº¿ç¨‹ä¸­å¦‚ä½•ä¿è¯i++çš„ç»“æœæ­£ç¡®
![image.png](./img/_kjzzIE5Zr7q1k8N/1686129979570-3830de07-a280-4b4c-8133-1636aac4d40d-385702.png)

- ä½¿ç”¨ Atomicå˜é‡ï¼ŒJava å¹¶å‘åŒ…å†…æä¾›äº†ä¸€äº›åŸå­ç±»å‹ï¼Œå¦‚AtomicIntegerã€AtomicLongç­‰ï¼Œè¿™äº›ç±»æä¾›äº†ä¸€äº›åŸå­æ“ä½œæ–¹æ³•ï¼Œå¯ä»¥ä¿è¯ç›¸åº”çš„æ“ä½œçš„åŸå­æ€§ã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1686115947980-127a9b63-e19f-436b-bb42-6c84406c069f-338345.png)
è¿™é‡Œä½¿ç”¨ AtomicInteger ç±»æ¥ä¿è¯ i++ æ“ä½œçš„åŸå­æ€§ã€‚

- ä½¿ç”¨synchronizedï¼Œå¯¹i++æ“ä½œåŠ é”ã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1686115898848-ffef1a32-542b-4678-b416-66590dd8d29c-628538.png)
è¿™é‡Œä½¿ç”¨ synchronized æ–¹æ³•æ¥ä¿è¯ increment() æ–¹æ³•çš„åŸå­æ€§ï¼Œä»è€Œä¿è¯ i++ æ“ä½œçš„ç»“æœæ­£ç¡®ã€‚

- ä½¿ç”¨é”æœºåˆ¶ï¼Œé™¤äº†ä½¿ç”¨ synchronized å…³é”®å­—å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ ReentrantLock ç±»æ¥ä¿æŠ¤ä¸´ç•ŒåŒºåŸŸã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1686116002798-83fd4311-36ef-4dc3-a6b0-ceb1af1f8e2e-605705.png)
è¿™é‡Œä½¿ç”¨ ReentrantLock ç±»çš„ lock() å’Œ unlock() æ–¹æ³•æ¥ä¿æŠ¤ i++æ“ä½œçš„åŸå­æ€§ã€‚

# 31.AtomicIntegerçš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ
ä¸€å¥è¯æ¦‚æ‹¬ï¼šä½¿ç”¨CASå®ç°ã€‚
åœ¨AtomicIntegerä¸­ï¼ŒCASæ“ä½œçš„æµç¨‹å¦‚ä¸‹ï¼š

1. è°ƒç”¨ incrementAndGet()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šé€šè¿‡è°ƒç”¨unsafe.getAndAddInt()æ–¹æ³•ï¼Œè·å–å½“å‰ AtomicIntegerå¯¹è±¡çš„å€¼val
2. å°† val + 1 å¾—åˆ°æ–°çš„å€¼ next

![image.png](./img/_kjzzIE5Zr7q1k8N/1686116763845-0789ea40-daaa-4cff-a430-8b525eab7da3-616483.png)

3. ä½¿ç”¨ unsafe.compareAndSwapInt() æ–¹æ³•è¿›è¡Œ CAS æ“ä½œï¼Œå°†å¯¹è±¡ä¸­å½“å‰å€¼ä¸é¢„æœŸå€¼ï¼ˆæ­¥éª¤1ä¸­è·å–çš„valï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™å°† nextèµ‹å€¼ç»™valï¼›å¦åˆ™è¿”å› false
4. å¦‚æœCASæ“ä½œè¿”å›falseï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å·²ç»ä¿®æ”¹äº†AtomicIntegerå¯¹è±¡çš„å€¼ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œæ­¥éª¤ 1

![image.png](./img/_kjzzIE5Zr7q1k8N/1686116809545-20a875cf-7985-4242-a919-98d3b0fcb60a-797597.png)
**æ€»ç»“ï¼š**
åœ¨ CAS æ“ä½œä¸­ï¼Œç”±äºåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æˆåŠŸä¿®æ”¹å…±äº«å˜é‡çš„å€¼ï¼Œå› æ­¤å¯ä»¥ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œå³å¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹AtomicIntegerå˜é‡æ—¶ä¹Ÿä¸ä¼šå‡ºç°ç«æ€æ¡ä»¶ã€‚è¿™æ ·å°±å¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®‰å…¨åœ°å¯¹AtomicIntegerè¿›è¡Œæ•´å‹å˜é‡æ“ä½œã€‚å…¶å®ƒçš„åŸå­æ“ä½œç±»åŸºæœ¬éƒ½æ˜¯å¤§åŒå°å¼‚ã€‚

# 32.ä»€ä¹ˆæ˜¯çº¿ç¨‹æ­»é”ï¼Ÿæˆ‘ä»¬è¯¥å¦‚ä½•é¿å…çº¿ç¨‹æ­»é”ï¼Ÿ
æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºèµ„æºè€Œé€ æˆçš„äº’ç›¸ç­‰å¾…çš„ç°è±¡ï¼Œåœ¨æ— å¤–åŠ›ä½œç”¨çš„æƒ…å†µä¸‹ï¼Œè¿™äº›çº¿ç¨‹ä¼šä¸€ç›´ç›¸äº’ç­‰å¾…è€Œæ— æ³•ç»§ç»­è¿è¡Œä¸‹å»ã€‚
![1685714751483-87755e4b-3902-4f90-8cca-7569d8090bec.png](./img/_kjzzIE5Zr7q1k8N/1685714751483-87755e4b-3902-4f90-8cca-7569d8090bec-375306.png)
é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šäº§ç”Ÿæ­»é”å‘¢ï¼Ÿæ­»é”çš„äº§ç”Ÿå¿…é¡»å…·å¤‡ä»¥ä¸‹å››ä¸ªæ¡ä»¶ï¼š
![image.png](./img/_kjzzIE5Zr7q1k8N/1685714879415-0c702550-a1eb-4336-94e2-cae7bb90fa64-681215.png)

- äº’æ–¥æ¡ä»¶ï¼šæŒ‡çº¿ç¨‹åœ¨å ç”¨æŸä¸ªèµ„æºæ—¶ï¼Œä¼šæŠŠè¯¥èµ„æºæ ‡è®°ä¸ºå·²å ç”¨ï¼Œå¹¶ä¸”é”ä½è¯¥èµ„æºï¼Œä»¥ä¿è¯**åŒä¸€æ—¶é—´å†…åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®è¯¥èµ„æº**ã€‚å…¶ä»–éœ€è¦è®¿é—®è¯¥èµ„æºçš„çº¿ç¨‹å°±åªèƒ½ç­‰å¾…è¯¥çº¿ç¨‹é‡Šæ”¾è¯¥èµ„æºï¼Œåœ¨èµ„æºè¢«é‡Šæ”¾ä¹‹åæ‰èƒ½è¿›è¡Œè®¿é—®ã€‚
- è¯·æ±‚å¹¶æŒæœ‰æ¡ä»¶ï¼šæŒ‡ä¸€ä¸ªçº¿ç¨‹å·±ç»æŒæœ‰äº†è‡³å°‘ä¸€ä¸ªèµ„æºï¼Œä½†åˆæå‡ºäº†æ–°çš„èµ„æºè¯·æ±‚ï¼Œè€Œæ–°èµ„æºå·±è¢«å…¶å®ƒçº¿ç¨‹å æœ‰ï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œä½†**é˜»å¡çš„åŒæ—¶å¹¶ä¸é‡Šæ”¾è‡ªå·±å·²ç»è·å–çš„èµ„æº**ã€‚
- ä¸å¯å‰¥å¤ºæ¡ä»¶ï¼šæŒ‡çº¿ç¨‹è·å–åˆ°çš„èµ„æºåœ¨è‡ªå·±**ä½¿ç”¨å®Œä¹‹å‰ä¸èƒ½è¢«å…¶å®ƒçº¿ç¨‹æŠ¢å **ï¼Œåªæœ‰åœ¨è‡ªå·±ä½¿ç”¨å®Œæ¯•åæ‰ç”±è‡ªå·±é‡Šæ”¾è¯¥èµ„æºã€‚
- ç¯è·¯ç­‰å¾…æ¡ä»¶ï¼šæŒ‡åœ¨å‘ç”Ÿæ­»é”æ—¶ï¼Œ**è‹¥å¹²çº¿ç¨‹å½¢æˆå¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚**

è¯¥å¦‚ä½•é¿å…æ­»é”å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‡³å°‘ç ´åæ­»é”å‘ç”Ÿçš„ä¸€ä¸ªæ¡ä»¶ã€‚

- äº’æ–¥ï¼šæˆ‘ä»¬æ²¡æœ‰åŠæ³•ç ´åï¼Œå› ä¸ºç”¨é”ä¸ºçš„å°±æ˜¯äº’æ–¥ã€‚ä¸è¿‡å…¶ä»–ä¸‰ä¸ªæ¡ä»¶éƒ½æ˜¯æœ‰åŠæ³•æ‰“ç ´çš„ï¼Œåˆ°åº•å¦‚ä½•åšå‘¢ï¼Ÿ
- è¯·æ±‚å¹¶æŒæœ‰ï¼šå¯ä»¥ä¸€æ¬¡æ€§è¯·æ±‚æ‰€æœ‰çš„èµ„æºã€‚
- ä¸å¯å‰¥å¤ºï¼šè®¾ç½®è¶…æ—¶æ—¶é—´ã€‚å·²ç»å ç”¨èµ„æºçš„çº¿ç¨‹è¿›ä¸€æ­¥ç”³è¯·å…¶ä»–èµ„æºæ—¶ï¼Œå¦‚æœé•¿æ—¶é—´ç”³è¯·ä¸åˆ°ï¼Œè¶…æ—¶é‡Šæ”¾å·²ç»æŒæœ‰çš„èµ„æºã€‚
- ç¯è·¯ç­‰å¾…ï¼šæ³¨æ„åŠ é”é¡ºåºï¼Œä¿è¯æ¯ä¸ªçº¿ç¨‹æŒ‰åŒæ ·çš„é¡ºåºè¿›è¡ŒåŠ é”ã€‚

# 33.å¦‚ä½•æ’æŸ¥æ­»é”é—®é¢˜
å¯ä»¥ä½¿ç”¨jdkè‡ªå¸¦çš„å‘½ä»¤è¡Œå·¥å…·æ’æŸ¥ï¼š

1. ä½¿ç”¨jpsæŸ¥æ‰¾è¿è¡Œçš„Javaè¿›ç¨‹ï¼šjps -l
2. ä½¿ç”¨jstackæŸ¥çœ‹çº¿ç¨‹å †æ ˆä¿¡æ¯ï¼šjstack -l  è¿›ç¨‹id

åŸºæœ¬å°±å¯ä»¥çœ‹åˆ°æ­»é”çš„ä¿¡æ¯ã€‚
è¿˜å¯ä»¥åˆ©ç”¨å›¾å½¢åŒ–å·¥å…·ï¼Œæ¯”å¦‚JConsoleï¼ˆJConsoleå·¥å…·åœ¨JDKçš„binç›®å½•ä¸­ï¼‰ã€‚å‡ºç°çº¿ç¨‹æ­»é”ä»¥åï¼Œç‚¹å‡»JConsoleçº¿ç¨‹é¢æ¿çš„æ£€æµ‹åˆ°æ­»é”æŒ‰é’®ï¼Œå°†ä¼šçœ‹åˆ°çº¿ç¨‹çš„æ­»é”ä¿¡æ¯ã€‚
æ¼”ç¤ºæ ·ä¾‹å¦‚ä¸‹ï¼š
```java
package lock;

/**
 * @author ç™¾é‡Œ
 */
public class BaiLiDeadLock {

    private static Object lock1 = new Object();
    private static Object lock2 = new Object();

    public static void main(String[] args) {
        Thread thread1 = new Thread(() -> {
            synchronized (lock1) {
                System.out.println("Thread-1è·å–äº†é”1");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized (lock2) {
                    System.out.println("Thread-1å°è¯•è·å–é”2");
                }
            }
        });

        Thread thread2 = new Thread(() -> {
            synchronized (lock2) {
                System.out.println("Thread-2è·å–äº†é”2");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized (lock1) {
                    System.out.println("Thread-2å°è¯•è·å–é”1");
                }
            }
        });
        thread1.start();
        thread2.start();
        try {
            thread1.join();
            thread2.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```
1.æ–°å»ºè¿æ¥ï¼Œæ‰¾åˆ°ç›¸åº”çš„çº¿ç¨‹ï¼Œç‚¹å‡»è¿æ¥
2.é€‰æ‹©çº¿ç¨‹æ ‡ç­¾ï¼Œç‚¹å‡»æ£€æµ‹æ­»é”ã€‚æŸ¥çœ‹æ­»é”çº¿ç¨‹ä¿¡æ¯
![image.png](./img/_kjzzIE5Zr7q1k8N/1686286011829-5d7efd01-4433-4b3f-84f1-2ed3da31eb01-175369.png)![image.png](./img/_kjzzIE5Zr7q1k8N/1686286059575-2013aba7-7283-4c16-b69b-b1e729f776f4-649223.png)
![image.png](./img/_kjzzIE5Zr7q1k8N/1686286150383-6e3c4feb-d5dd-49f6-883c-5c559e394325-858439.png)
![image.png](./img/_kjzzIE5Zr7q1k8N/1686286161193-40b39340-0a6e-4c9e-b075-780354f65690-598584.png)


# 34.ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± ï¼Ÿ
çº¿ç¨‹æ± æ˜¯ä¸€ç§ç”¨äºç®¡ç†å’Œå¤ç”¨çº¿ç¨‹çš„æœºåˆ¶ï¼Œå®ƒæä¾›äº†ä¸€ç§æ‰§è¡Œå¤§é‡å¼‚æ­¥ä»»åŠ¡çš„æ–¹å¼ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å¤šä¸ªä»»åŠ¡ä¹‹é—´åˆç†åœ°åˆ†é…å’Œç®¡ç†ç³»ç»Ÿèµ„æºã€‚
çº¿ç¨‹æ± çš„ä¸»è¦ä¼˜ç‚¹åŒ…æ‹¬ï¼š

- æ”¹å–„äº†èµ„æºåˆ©ç”¨ç‡ï¼Œé™ä½äº†çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€ã€‚
- æé«˜äº†ç³»ç»Ÿå“åº”é€Ÿåº¦ï¼Œå› ä¸ºçº¿ç¨‹æ± å·²ç»é¢„å…ˆåˆ›å»ºå¥½äº†ä¸€äº›çº¿ç¨‹ï¼Œå¯ä»¥æ›´åŠ å¿«é€Ÿåœ°åˆ†é…èµ„æºä»¥å“åº”ç”¨æˆ·è¯·æ±‚ã€‚
- æé«˜äº†ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œå› ä¸ºçº¿ç¨‹æ± å°†çº¿ç¨‹ç®¡ç†å’Œä»»åŠ¡æ‰§è¡Œè¿›è¡Œäº†åˆ†ç¦»ï¼Œå¯ä»¥æ›´åŠ æ–¹ä¾¿åœ°å¯¹å…¶è¿›è¡Œè°ƒæ•´å’Œä¼˜åŒ–ã€‚
- å¯ä»¥è®¾ç½®çº¿ç¨‹æ•°ç›®ä¸Šé™ï¼Œé¿å…äº†ç¼ºä¹æ§åˆ¶çš„çº¿ç¨‹åˆ›å»ºé€ æˆçš„ç³»ç»Ÿæ— æ³•æ‰¿å—çš„è´Ÿè½½å‹åŠ›ã€‚

# 35.ç®€å•è¯´ä¸€ä¸‹çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹
ç”¨ä¸€ä¸ªé€šä¿—çš„æ¯”å–»ï¼š
æœ‰ä¸€ä¸ªé“¶è¡Œè¥ä¸šå…ï¼Œæ€»å…±æœ‰å…­ä¸ªçª—å£ï¼Œç°åœ¨æœ‰ä¸‰ä¸ªçª—å£åç€ä¸‰ä¸ªè¥ä¸šå‘˜å°å§å§åœ¨è¥ä¸šã€‚å°å¤©å»åŠä¸šåŠ¡ï¼Œå¯èƒ½ä¼šé‡åˆ°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ

1. å°å¤©å‘ç°æœ‰ç©ºé—²çš„çª—å£ï¼Œç›´æ¥å»æ‰¾å°å§å§åŠç†ä¸šåŠ¡ã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1685965525491-53d3aeb3-5a46-41bc-9bc9-e9b62db106d2-647246.png)

2. å°å¤©å‘ç°æ²¡æœ‰ç©ºé—²çš„çª—å£ï¼Œå°±åœ¨æ’é˜ŸåŒºæ’é˜Ÿç­‰ã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1685966053944-78593221-0205-4382-859b-ae3b3a428706-589699.png)

3. å°å¤©å‘ç°æ²¡æœ‰ç©ºé—²çš„çª—å£ï¼Œç­‰å¾…åŒºä¹Ÿæ»¡äº†ï¼Œç»ç†ä¸€çœ‹ï¼Œå°±è®©ä¼‘æ¯çš„è¥ä¸šå‘˜å°å§å§èµ¶ç´§å›æ¥ä¸Šç­ï¼Œç­‰å¾…åŒºå·é å‰çš„èµ¶ç´§å»æ–°çª—å£åŠï¼Œå°å¤©å»æ’é˜ŸåŒºæ’é˜Ÿã€‚å°å§å§æ¯”è¾ƒè¾›è‹¦ï¼Œå‡å¦‚ä¸€æ®µæ—¶é—´å‘ç°ä»–ä»¬å¯ä»¥ä¸ç”¨æ¥ç€è¥ä¸šï¼Œç»ç†å°±è®©å¥¹ä»¬æ¥ç€ä¼‘æ¯ã€‚

![image.png](./img/_kjzzIE5Zr7q1k8N/1685966244206-798dd4b4-eff2-4472-8e8a-aac0b4e83bcb-113738.png)

4. å°å¤©ä¸€çœ‹ï¼Œå…­ä¸ªçª—å£éƒ½æ»¡äº†ï¼Œç­‰å¾…åŒºä¹Ÿæ²¡ä½ç½®äº†ã€‚å°å¤©å°±å¼€å§‹æŠ•è¯‰æ€¥äº†ï¼Œè¦é—¹ï¼Œç»ç†èµ¶ç´§å‡ºæ¥äº†ï¼Œç»ç†è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

![image.png](./img/_kjzzIE5Zr7q1k8N/1685966534116-32317a6e-1213-4a70-8a50-72b3905d39bd-346835.png)

1. æˆ‘ä»¬é“¶è¡Œç³»ç»Ÿå·²ç»ç˜«ç—ª
2. è°å«ä½ æ¥åŠçš„ä½ æ‰¾è°å»
3. çœ‹ä½ æ¯”è¾ƒæ€¥ï¼Œå»é˜Ÿé‡ŒåŠ ä¸ªå¡
4. ä»Šå¤©æ²¡åŠæ³•ï¼Œä¸è¡Œä½ çœ‹æ”¹ä¸€å¤©

**ä¸Šé¢çš„è¿™ä¸ªæµç¨‹å‡ ä¹å°±è·ŸJDKçº¿ç¨‹æ± çš„å¤§è‡´æµç¨‹ç±»ä¼¼ã€‚**

1. è¥ä¸šä¸­çš„ 3ä¸ªçª—å£å¯¹åº”æ ¸å¿ƒçº¿ç¨‹æ± æ•°ï¼šcorePoolSize
2. æ€»çš„è¥ä¸šçª—å£æ•°6å¯¹åº”ï¼šmaximumPoolSize
3. æ‰“å¼€çš„ä¸´æ—¶çª—å£åœ¨å¤šå°‘æ—¶é—´å†…æ— äººåŠç†åˆ™å…³é—­å¯¹åº”ï¼šunit
4. æ’é˜ŸåŒºå°±æ˜¯ç­‰å¾…é˜Ÿåˆ—ï¼šworkQueue
5. æ— æ³•åŠç†çš„æ—¶å€™é“¶è¡Œç»™å‡ºçš„è§£å†³æ–¹æ³•å¯¹åº”ï¼šRejectedExecutionHandler
6. threadFactory è¯¥å‚æ•°åœ¨JDKä¸­æ˜¯çº¿ç¨‹å·¥å‚ï¼Œç”¨æ¥åˆ›å»ºçº¿ç¨‹å¯¹è±¡ï¼Œä¸€èˆ¬ä¸ä¼šåŠ¨ã€‚

æ‰€ä»¥æˆ‘ä»¬çº¿ç¨‹æ± çš„å·¥ä½œæµç¨‹ä¹Ÿæ¯”è¾ƒå¥½ç†è§£äº†ï¼š
![image.png](./img/_kjzzIE5Zr7q1k8N/1685967392999-cbae3b8b-163d-4ef3-8df9-98fbf2466d61-696157.png)

1. çº¿ç¨‹æ± åˆšåˆ›å»ºæ—¶ï¼Œé‡Œé¢æ²¡æœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚ä»»åŠ¡é˜Ÿåˆ—æ˜¯ä½œä¸ºå‚æ•°ä¼ è¿›æ¥çš„ã€‚ä¸è¿‡ï¼Œå°±ç®—é˜Ÿåˆ—é‡Œé¢æœ‰ä»»åŠ¡ï¼Œçº¿ç¨‹æ± ä¹Ÿä¸ä¼šé©¬ä¸Šæ‰§è¡Œå®ƒä»¬ã€‚
2. å½“è°ƒç”¨ execute() æ–¹æ³•æ·»åŠ ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåšå¦‚ä¸‹åˆ¤æ–­ï¼š
- å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å°äº corePoolSizeï¼Œé‚£ä¹ˆé©¬ä¸Šåˆ›å»ºçº¿ç¨‹è¿è¡Œè¿™ä¸ªä»»åŠ¡ï¼›
- å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äº corePoolSizeï¼Œé‚£ä¹ˆå°†è¿™ä¸ªä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼›
- å¦‚æœè¿™æ—¶å€™é˜Ÿåˆ—æ»¡äº†ï¼Œè€Œä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å°äº maximumPoolSizeï¼Œé‚£ä¹ˆè¿˜æ˜¯è¦åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ç«‹åˆ»è¿è¡Œè¿™ä¸ªä»»åŠ¡ï¼›
- å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œè€Œä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äº maximumPoolSizeï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šæ ¹æ®æ‹’ç»ç­–ç•¥æ¥å¯¹åº”å¤„ç†ã€‚
3. å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡æ—¶ï¼Œå®ƒä¼šä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œã€‚
4. å½“ä¸€ä¸ªçº¿ç¨‹æ— äº‹å¯åšï¼Œè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼ˆkeepAliveTimeï¼‰æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ¤æ–­ï¼Œå¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äº corePoolSizeï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±è¢«åœæ‰ã€‚æ‰€ä»¥çº¿ç¨‹æ± çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œå®ƒæœ€ç»ˆä¼šæ”¶ç¼©åˆ° corePoolSize çš„å¤§å°ã€‚

# 36.çº¿ç¨‹æ± ä¸»è¦å‚æ•°æœ‰å“ªäº›ï¼Ÿ
![1685967614703-3dee86b6-8ee6-4bbb-8b0b-4e3984caf99a.jpeg](./img/_kjzzIE5Zr7q1k8N/1685967614703-3dee86b6-8ee6-4bbb-8b0b-4e3984caf99a-619322.jpeg)
```java
package pool;

import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.Executors;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

/**
 * @author ç™¾é‡Œ
 */
public class BaiLiThreadPoolDemo {
    public static void main(String[] args) {
        //åŸºäºExecutoræ¡†æ¶å®ç°çº¿ç¨‹æ± 
        ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(
                5,  //corePoolSize
                12,  //maximumPoolSize
                5,  //keepAliveTime
                TimeUnit.SECONDS,   //unit
                new ArrayBlockingQueue<>(5),  //workQueue
                Executors.defaultThreadFactory(),  //threadFactory
                new ThreadPoolExecutor.DiscardPolicy()  //handler
        );
        threadPoolExecutor.execute(() -> {
            System.out.println(
                    Thread.currentThread().getName() + "ï¼šç‚¹èµè¯„è®ºåŠ åˆ†äº«"
            );
        });
    }
}
```
çº¿ç¨‹æ± æœ‰ä¸ƒå¤§å‚æ•°ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨**corePoolSizeã€maximumPoolSizeã€workQueueã€handler** å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£å’Œä¼˜åŒ–çº¿ç¨‹æ± çš„æ€§èƒ½

1. **corePoolSize**

æ­¤å€¼æ˜¯ç”¨æ¥åˆå§‹åŒ–çº¿ç¨‹æ± ä¸­æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå½“çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°< corePoolSizeæ—¶ï¼Œç³»ç»Ÿé»˜è®¤æ˜¯æ·»åŠ ä¸€ä¸ªä»»åŠ¡æ‰åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ã€‚å½“çº¿ç¨‹æ•° = corePoolSizeæ—¶ï¼Œæ–°ä»»åŠ¡ä¼šè¿½åŠ åˆ°workQueueä¸­ã€‚

2. **maximumPoolSize**

maximumPoolSizeè¡¨ç¤ºå…è®¸çš„æœ€å¤§çº¿ç¨‹æ•° = (éæ ¸å¿ƒçº¿ç¨‹æ•°+æ ¸å¿ƒçº¿ç¨‹æ•°)ï¼Œå½“BlockingQueueä¹Ÿæ»¡äº†ï¼Œä½†çº¿ç¨‹æ± ä¸­æ€»çº¿ç¨‹æ•° < maximumPoolSizeæ—¶å€™å°±ä¼šå†æ¬¡åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚

3. **keepAliveTime**

éæ ¸å¿ƒçº¿ç¨‹ =(maximumPoolSize - corePoolSize ) ,éæ ¸å¿ƒçº¿ç¨‹é—²ç½®ä¸‹æ¥ä¸å¹²æ´»æœ€å¤šå­˜æ´»æ—¶é—´ã€‚

4. **unit**

çº¿ç¨‹æ± ä¸­éæ ¸å¿ƒçº¿ç¨‹ä¿æŒå­˜æ´»çš„æ—¶é—´çš„å•ä½

- TimeUnit.DAYS;å¤©
- TimeUnit.HOURS;å°æ—¶
- TimeUnit.MINUTES;åˆ†é’Ÿ
- TimeUnit.SECONDS;ç§’
- TimeUnit.MILLISECONDS;  æ¯«ç§’
- TimeUnit.MICROSECONDS;  å¾®ç§’
- TimeUnit.NANOSECONDS;  çº³ç§’
5. **workQueue**

çº¿ç¨‹æ± ç­‰å¾…é˜Ÿåˆ—ï¼Œç»´æŠ¤ç€ç­‰å¾…æ‰§è¡Œçš„Runnableå¯¹è±¡ã€‚å½“è¿è¡Œå½“çº¿ç¨‹æ•°= corePoolSizeæ—¶ï¼Œæ–°çš„ä»»åŠ¡ä¼šè¢«æ·»åŠ åˆ°workQueueä¸­ï¼Œå¦‚æœworkQueueä¹Ÿæ»¡äº†åˆ™å°è¯•ç”¨éæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œç­‰å¾…é˜Ÿåˆ—åº”è¯¥å°½é‡ç”¨æœ‰ç•Œçš„ã€‚

6. **threadFactory**

åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ—¶ä½¿ç”¨çš„å·¥å‚ï¼Œå¯ä»¥ç”¨æ¥è®¾å®šçº¿ç¨‹åã€æ˜¯å¦ä¸ºdaemonçº¿ç¨‹ç­‰ç­‰ã€‚

7. **handler**

corePoolSizeã€workQueueã€maximumPoolSizeéƒ½ä¸å¯ç”¨çš„æ—¶å€™æ‰§è¡Œçš„é¥±å’Œç­–ç•¥ã€‚

# 37.çº¿ç¨‹æ± çš„æ‹’ç»ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ
åœ¨çº¿ç¨‹æ± ä¸­ï¼Œå½“æäº¤çš„ä»»åŠ¡æ•°é‡è¶…è¿‡äº†çº¿ç¨‹æ± çš„æœ€å¤§å®¹é‡ï¼Œçº¿ç¨‹æ± å°±éœ€è¦ä½¿ç”¨æ‹’ç»ç­–ç•¥æ¥å¤„ç†æ— æ³•å¤„ç†çš„æ–°ä»»åŠ¡ã€‚Java ä¸­æä¾›äº† 4 ç§é»˜è®¤çš„æ‹’ç»ç­–ç•¥:

- AbortPolicyï¼ˆé»˜è®¤ç­–ç•¥ï¼‰ï¼šç›´æ¥æŠ›å‡º runtime å¼‚å¸¸ï¼Œé˜»æ­¢ç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚
- CallerRunsPolicyï¼šç”±æäº¤è¯¥ä»»åŠ¡çš„çº¿ç¨‹æ¥æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ã€‚
- DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼Œä¸ç»™äºˆä»»ä½•å¤„ç†ã€‚
- DiscardOldestPolicyï¼šä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ä¸€ä¸ªè¯·æ±‚ï¼Œå°è¯•å†æ¬¡æäº¤å½“å‰ä»»åŠ¡ã€‚

é™¤äº†è¿™äº›é»˜è®¤çš„ç­–ç•¥ä¹‹å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„æ‹’ç»ç­–ç•¥ï¼Œå®ç°RejectedExecutionHandleræ¥å£å³å¯ã€‚
```java
public class CustomRejectedExecutionHandler implements RejectedExecutionHandler {
    @Override
    public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) {
        // è‡ªå®šä¹‰çš„æ‹’ç»ç­–ç•¥å¤„ç†é€»è¾‘
    }
}
```

# 38.çº¿ç¨‹æ± æœ‰å“ªå‡ ç§å·¥ä½œé˜Ÿåˆ—
![1685968453891-4c5f1921-da73-4c62-a52c-4dd336d176b4.jpeg](./img/_kjzzIE5Zr7q1k8N/1685968453891-4c5f1921-da73-4c62-a52c-4dd336d176b4-025445.jpeg)

- **æœ‰ç•Œé˜Ÿåˆ—**ï¼ˆArrayBlockingQueueï¼‰ï¼šæ˜¯ä¸€ä¸ªç”¨æ•°ç»„å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰FIFOæ’åºã€‚
- **æ— ç•Œé˜Ÿåˆ—**ï¼ˆLinkedBlockingQueueï¼‰ï¼šæ˜¯åŸºäºé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰FIFOæ’åºï¼Œå®¹é‡å¯ä»¥é€‰æ‹©è¿›è¡Œè®¾ç½®ï¼Œä¸è®¾ç½®çš„è¯ï¼Œå°†æ˜¯ä¸€ä¸ªæ— è¾¹ç•Œçš„é˜»å¡é˜Ÿåˆ—ï¼Œå› æ­¤åœ¨ä»»åŠ¡æ•°é‡å¾ˆå¤§ä¸”ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒé•¿æ—¶ï¼Œæ— ç•Œé˜Ÿåˆ—å¯ä»¥ä¿è¯ä»»åŠ¡ä¸ä¼šè¢«ä¸¢å¼ƒï¼Œä½†åŒæ—¶ä¹Ÿä¼šå¯¼è‡´çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡ä¸æ–­å¢åŠ ï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æº¢å‡ºç­‰é—®é¢˜ã€‚
- **å»¶è¿Ÿé˜Ÿåˆ—**ï¼ˆDelayQueueï¼‰ï¼šæ˜¯ä¸€ä¸ªä»»åŠ¡å®šæ—¶å‘¨æœŸçš„å»¶è¿Ÿæ‰§è¡Œçš„é˜Ÿåˆ—ã€‚æ ¹æ®æŒ‡å®šçš„æ‰§è¡Œæ—¶é—´ä»å°åˆ°å¤§æ’åºï¼Œå¦åˆ™æ ¹æ®æ’å…¥åˆ°é˜Ÿåˆ—çš„å…ˆåæ’åºã€‚
- **ä¼˜å…ˆçº§é˜Ÿåˆ—**ï¼ˆPriorityBlockingQueueï¼‰ï¼šæ˜¯å…·æœ‰ä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ä¸æ— ç•Œé˜Ÿåˆ—ç±»ä¼¼ï¼Œä¼˜å…ˆçº§é˜Ÿåˆ—å¯ä»¥ä¿è¯æ‰€æœ‰ä»»åŠ¡éƒ½ä¼šè¢«æ‰§è¡Œï¼Œä½†ä¸åŒçš„æ˜¯ä¼˜å…ˆçº§é˜Ÿåˆ—å¯ä»¥å¯¹ä»»åŠ¡è¿›è¡Œç®¡ç†å’Œæ’åºï¼Œç¡®ä¿é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œã€‚
- **åŒæ­¥é˜Ÿåˆ—**ï¼ˆSynchronousQueueï¼‰ï¼šæ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œååé‡é€šå¸¸è¦é«˜äºæ— ç•Œé˜Ÿåˆ—ã€‚

# 39.çº¿ç¨‹æ± æäº¤executeå’Œsubmitæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
åœ¨Javaä¸­ï¼Œçº¿ç¨‹æ± ä¸­ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•æ¥æäº¤ä»»åŠ¡ï¼šexecute() å’Œ submit()

1. execute() ç”¨äºæäº¤ä¸éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡

![image.png](./img/_kjzzIE5Zr7q1k8N/1686467547524-7b66a970-ddb3-4fe2-ad68-cad94fc99929-576632.png)

2. submit() ç”¨äºæäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ã€‚çº¿ç¨‹æ± ä¼šè¿”å›ä¸€ä¸ªfutureç±»å‹çš„å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ª futureå¯¹è±¡å¯ä»¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡futureçš„get()æ–¹æ³•æ¥è·å–è¿”å›å€¼

![image.png](./img/_kjzzIE5Zr7q1k8N/1686467573413-64b98310-f0fb-475a-9daf-f48e4f9961a2-221607.png)

# 40.æ€ä¹ˆå…³é—­çº¿ç¨‹æ± ï¼Ÿ
å¯ä»¥é€šè¿‡è°ƒç”¨çº¿ç¨‹æ± çš„shutdownæˆ–shutdownNowæ–¹æ³•æ¥å…³é—­çº¿ç¨‹æ± ã€‚å®ƒä»¬çš„åŸç†æ˜¯éå†çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹ï¼Œç„¶åé€ä¸ªè°ƒç”¨çº¿ç¨‹çš„interruptæ–¹æ³•æ¥ä¸­æ–­çº¿ç¨‹ï¼Œæ‰€ä»¥æ— æ³•å“åº”ä¸­æ–­çš„ä»»åŠ¡å¯èƒ½æ°¸è¿œæ— æ³•ç»ˆæ­¢ã€‚
**shutdownï¼š**å°†çº¿ç¨‹æ± çŠ¶æ€ç½®ä¸ºshutdown,å¹¶ä¸ä¼šç«‹å³åœæ­¢ï¼š

1. åœæ­¢æ¥æ”¶å¤–éƒ¨submitçš„ä»»åŠ¡
2. å†…éƒ¨æ­£åœ¨è·‘çš„ä»»åŠ¡å’Œé˜Ÿåˆ—é‡Œç­‰å¾…çš„ä»»åŠ¡ï¼Œä¼šæ‰§è¡Œå®Œ
3. ç­‰åˆ°ç¬¬äºŒæ­¥å®Œæˆåï¼Œæ‰çœŸæ­£åœæ­¢

**shutdownNowï¼š**å°†çº¿ç¨‹æ± çŠ¶æ€ç½®ä¸ºstopã€‚ä¸€èˆ¬ä¼šç«‹å³åœæ­¢ï¼Œäº‹å®ä¸Šä¸ä¸€å®šï¼š

1. å’Œshutdown()ä¸€æ ·ï¼Œå…ˆåœæ­¢æ¥æ”¶å¤–éƒ¨æäº¤çš„ä»»åŠ¡
2. å¿½ç•¥é˜Ÿåˆ—é‡Œç­‰å¾…çš„ä»»åŠ¡
3. å°è¯•å°†æ­£åœ¨è·‘çš„ä»»åŠ¡interruptä¸­æ–­
4. è¿”å›æœªæ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨

**shutdown å’ŒshutdownnowåŒºåˆ«å¦‚ä¸‹**ï¼š

- **shutdownNow**ï¼šèƒ½ç«‹å³åœæ­¢çº¿ç¨‹æ± ï¼Œæ­£åœ¨è·‘çš„å’Œæ­£åœ¨ç­‰å¾…çš„ä»»åŠ¡éƒ½åœä¸‹äº†ã€‚è¿™æ ·åšç«‹å³ç”Ÿæ•ˆï¼Œä½†æ˜¯é£é™©ä¹Ÿæ¯”è¾ƒå¤§ã€‚
- **shutdown**ï¼šåªæ˜¯å…³é—­äº†æäº¤é€šé“ï¼Œç”¨submit()æ˜¯æ— æ•ˆçš„ï¼›è€Œå†…éƒ¨çš„ä»»åŠ¡è¯¥æ€ä¹ˆè·‘è¿˜æ˜¯æ€ä¹ˆè·‘ï¼Œè·‘å®Œå†å½»åº•åœæ­¢çº¿ç¨‹æ± ã€‚
```java
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

/**
 * @author ç™¾é‡Œ
 */
public class BaiLiShutdownDemo {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼ŒåŒ…å«ä¸¤ä¸ªçº¿ç¨‹
        ExecutorService executor = Executors.newFixedThreadPool(2);

        // æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± 
        executor.submit(() -> {
            try {
                Thread.sleep(30000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            System.out.println("Task 1 finished");
        });

        executor.submit(() -> {
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
            System.out.println("Task 2 finished");
        });

        // å…³é—­çº¿ç¨‹æ± 
        executor.shutdown();

        while (!executor.isTerminated()) {
            System.out.println("Waiting for all tasks to finish...");
            try {
                // æ¯500æ¯«ç§’æ£€æŸ¥ä¸€æ¬¡
                Thread.sleep(500);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }

        System.out.println("All tasks finished");
    }
}
```
```java
import java.util.List;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

/**
 * @author ç™¾é‡Œ
 */
public class BaiLiShutdownNowDemo {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼ŒåŒ…å«ä¸¤ä¸ªçº¿ç¨‹
        ExecutorService executor = Executors.newFixedThreadPool(2);

        // æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± 
        executor.submit(() -> {
            while (!Thread.interrupted()) {
                System.out.println("Task 1 running...");
            }
            System.out.println("Task 1 interrupted");
        });

        executor.submit(() -> {
            while (!Thread.interrupted()) {
                System.out.println("Task 2 running...");
            }
            System.out.println("Task 2 interrupted");
        });

        // å…³é—­çº¿ç¨‹æ± 
        List<Runnable> unfinishedTasks = null;
        executor.shutdownNow();

        try {
            // ç­‰å¾…ç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆæˆ–è¶…æ—¶60ç§’
            if (!executor.awaitTermination(60, TimeUnit.SECONDS)) {
                // å¦‚æœç­‰å¾…è¶…æ—¶ï¼Œåˆ™è®°å½•æœªå®Œæˆçš„ä»»åŠ¡åˆ—è¡¨
                unfinishedTasks = executor.shutdownNow();
                System.out.println("Some tasks were not finished");
            }
        } catch (InterruptedException e) {
            // å¦‚æœç­‰å¾…è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™è®°å½•æœªå®Œæˆçš„ä»»åŠ¡åˆ—è¡¨
            unfinishedTasks = executor.shutdownNow();
            Thread.currentThread().interrupt();
        }

        if (unfinishedTasks != null && !unfinishedTasks.isEmpty()) {
            System.out.println("Unfinished tasks: " + unfinishedTasks);
        } else {
            System.out.println("All tasks finished");
        }
    }
}
```

# 41.æœ‰å“ªå‡ ç§å¸¸è§çš„çº¿ç¨‹æ± 
åœ¨Javaä¸­ï¼Œå¸¸è§çš„çº¿ç¨‹æ± ç±»å‹ä¸»è¦æœ‰å››ç§ï¼Œéƒ½æ˜¯é€šè¿‡å·¥å…·ç±»Excutorsåˆ›å»ºå‡ºæ¥çš„ã€‚
![1685975431317-106baa68-5d49-4e80-83dc-92e6856bfcdd.jpeg](./img/_kjzzIE5Zr7q1k8N/1685975431317-106baa68-5d49-4e80-83dc-92e6856bfcdd-667985.jpeg)

- **newFixedThreadPool  (å›ºå®šæ•°ç›®çº¿ç¨‹)**ï¼šè¯¥çº¿ç¨‹æ± å…·æœ‰å›ºå®šçš„çº¿ç¨‹æ•°ï¼Œå½“æäº¤çš„ä»»åŠ¡è¶…è¿‡çº¿ç¨‹æ± å¤§å°æ—¶ï¼Œä¼šå°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ
- **newCachedThreadPool (å¯ç¼“å­˜çº¿ç¨‹)**ï¼šè¯¥çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°ä¸å®šï¼Œå½“çº¿ç¨‹æ± ä¸­æœ‰ç©ºé—²çº¿ç¨‹æ—¶ï¼Œä¼šç›´æ¥ä½¿ç”¨ç©ºé—²çº¿ç¨‹ï¼Œå¦åˆ™ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚é€‚ç”¨äºæ‰§è¡Œå¤§é‡çŸ­ç”Ÿå‘½å‘¨æœŸçš„å¼‚æ­¥ä»»åŠ¡ã€‚
- **newSingleThreadExecutor (å•çº¿ç¨‹)**ï¼šè¯¥çº¿ç¨‹æ± åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨è¯¥çº¿ç¨‹æ‰§è¡Œä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–ä»»åŠ¡éƒ½ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œã€‚
- **newScheduledThreadPool (å®šæ—¶åŠå‘¨æœŸæ‰§è¡Œ)**ï¼šè¯¥çº¿ç¨‹æ± å¯ä»¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡å’Œå‘¨æœŸæ€§ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥æäº¤æ™®é€šçš„å¼‚æ­¥ä»»åŠ¡ã€‚

éœ€è¦æ³¨æ„é˜¿é‡Œå·´å·´ã€ŠJavaå¼€å‘æ‰‹å†Œã€‹é‡Œç¦æ­¢ä½¿ç”¨è¿™ç§æ–¹å¼æ¥åˆ›å»ºçº¿ç¨‹æ± ã€‚

# 42.è¯´ä¸€è¯´newSingleThreadExecutorå·¥ä½œåŸç†
![image.png](./img/_kjzzIE5Zr7q1k8N/1686472433725-ed7e8e5b-9e65-4831-99ec-422511ea06d5-330679.png)çº¿ç¨‹æ± ç‰¹ç‚¹ï¼š

- æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º1
- æœ€å¤§çº¿ç¨‹æ•°ä¹Ÿä¸º1
- é˜»å¡é˜Ÿåˆ—æ˜¯æ— ç•Œé˜Ÿåˆ—LinkedBlockingQueueï¼Œå¯èƒ½ä¼šå¯¼è‡´OOM
- keepAliveTimeä¸º0

![image.png](./img/_kjzzIE5Zr7q1k8N/1685969452991-af1f4ae1-7bfb-4946-9934-b3d2142d9769-268766.png)
å·¥ä½œæµç¨‹ï¼š

- æäº¤ä»»åŠ¡
- çº¿ç¨‹æ± æ˜¯å¦æœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è¿è¡Œï¼Œå¦‚æœæ²¡æœ‰ï¼Œæ–°å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡
- å¦‚æœæœ‰å¹¶ä¸”éç©ºé—²çŠ¶æ€ï¼Œå°†ä»»åŠ¡åŠ åˆ°é˜»å¡é˜Ÿåˆ—
- å½“å‰çš„å”¯ä¸€çº¿ç¨‹ï¼Œä»é˜Ÿåˆ—å–ä»»åŠ¡ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªï¼Œå†ç»§ç»­å–ï¼Œä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‚

ä½¿ç”¨åœºæ™¯ï¼š
é€‚ç”¨äºä¸²è¡Œæ‰§è¡Œä»»åŠ¡çš„åœºæ™¯ï¼Œä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªä»»åŠ¡åœ°æ‰§è¡Œã€‚

# 43.è¯´ä¸€è¯´newFixedThreadPoolå·¥ä½œåŸç†
![image.png](./img/_kjzzIE5Zr7q1k8N/1686472468365-dccdd0e1-4dca-482b-be6c-028f2397b2e3-774566.png)çº¿ç¨‹æ± ç‰¹ç‚¹ï¼š

- æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°å¤§å°ä¸€æ ·
- æ²¡æœ‰æ‰€è°“çš„éç©ºé—²æ—¶é—´ï¼Œå³keepAliveTimeä¸º0
- é˜»å¡é˜Ÿåˆ—ä¸ºæ— ç•Œé˜Ÿåˆ—LinkedBlockingQueueï¼Œå¯èƒ½ä¼šå¯¼è‡´OOM

![image.png](./img/_kjzzIE5Zr7q1k8N/1685969663788-910bc3f0-d708-426d-bfed-37e0a1dd0967-804089.png)
å·¥ä½œæµç¨‹ï¼š

- æäº¤ä»»åŠ¡
- å¦‚æœçº¿ç¨‹æ•°å°‘äºæ ¸å¿ƒçº¿ç¨‹ï¼Œåˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡
- å¦‚æœçº¿ç¨‹æ•°ç­‰äºæ ¸å¿ƒçº¿ç¨‹ï¼ŒæŠŠä»»åŠ¡æ·»åŠ åˆ°LinkedBlockingQueueé˜»å¡é˜Ÿåˆ—
- å¦‚æœçº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡ï¼Œå»é˜»å¡é˜Ÿåˆ—å–ä»»åŠ¡ï¼Œç»§ç»­æ‰§è¡Œã€‚

ä½¿ç”¨åœºæ™¯ï¼š
FixedThreadPool é€‚ç”¨äºå¤„ç†CPUå¯†é›†å‹çš„ä»»åŠ¡ï¼Œç¡®ä¿CPUåœ¨é•¿æœŸè¢«å·¥ä½œçº¿ç¨‹ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œå°½å¯èƒ½çš„å°‘çš„åˆ†é…çº¿ç¨‹ï¼Œå³é€‚ç”¨æ‰§è¡Œé•¿æœŸçš„ä»»åŠ¡ã€‚

# 44.è¯´ä¸€è¯´newCachedThreadPoolå·¥ä½œåŸç†
![image.png](./img/_kjzzIE5Zr7q1k8N/1686472503394-c9c403fb-d360-4b72-9a45-b8aa41ff6b19-716926.png)
çº¿ç¨‹æ± ç‰¹ç‚¹ï¼š

- æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0
- æœ€å¤§çº¿ç¨‹æ•°ä¸ºInteger.MAX_VALUEï¼Œå³æ— é™å¤§ï¼Œå¯èƒ½ä¼šå› ä¸ºæ— é™åˆ›å»ºçº¿ç¨‹ï¼Œå¯¼è‡´OOM
- é˜»å¡é˜Ÿåˆ—æ˜¯SynchronousQueue
- éæ ¸å¿ƒçº¿ç¨‹ç©ºé—²å­˜æ´»æ—¶é—´ä¸º60ç§’

å½“æäº¤ä»»åŠ¡çš„é€Ÿåº¦å¤§äºå¤„ç†ä»»åŠ¡çš„é€Ÿåº¦æ—¶ï¼Œæ¯æ¬¡æäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œå°±å¿…ç„¶ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚æç«¯æƒ…å†µä¸‹ä¼šåˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹ï¼Œè€—å°½ CPU å’Œå†…å­˜èµ„æºã€‚ç”±äºç©ºé—² 60 ç§’çš„çº¿ç¨‹ä¼šè¢«ç»ˆæ­¢ï¼Œé•¿æ—¶é—´ä¿æŒç©ºé—²çš„ CachedThreadPool ä¸ä¼šå ç”¨ä»»ä½•èµ„æºã€‚
![image.png](./img/_kjzzIE5Zr7q1k8N/1685969869991-8b7d5093-22e9-4a62-b50e-9fc96d61ef56-317733.png)
å·¥ä½œæµç¨‹ï¼š

- æäº¤ä»»åŠ¡
- å› ä¸ºæ²¡æœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œæ‰€ä»¥ä»»åŠ¡ç›´æ¥åŠ åˆ°SynchronousQueueé˜Ÿåˆ—ã€‚
- åˆ¤æ–­æ˜¯å¦æœ‰ç©ºé—²çº¿ç¨‹ï¼Œå¦‚æœæœ‰ï¼Œå°±å»å–å‡ºä»»åŠ¡æ‰§è¡Œã€‚
- å¦‚æœæ²¡æœ‰ç©ºé—²çº¿ç¨‹ï¼Œå°±æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚
- æ‰§è¡Œå®Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œè¿˜å¯ä»¥å­˜æ´»60ç§’ï¼Œå¦‚æœåœ¨è¿™æœŸé—´ï¼Œæ¥åˆ°ä»»åŠ¡ï¼Œå¯ä»¥ç»§ç»­æ´»ä¸‹å»ï¼›å¦åˆ™ï¼Œè¢«é”€æ¯ã€‚

ä½¿ç”¨åœºæ™¯ï¼š
ç”¨äºå¹¶å‘æ‰§è¡Œå¤§é‡çŸ­æœŸçš„å°ä»»åŠ¡ã€‚

# 45.è¯´ä¸€è¯´**newScheduledThreadPool**å·¥ä½œåŸç†
![image.png](./img/_kjzzIE5Zr7q1k8N/1686489942182-fceba219-b11e-4b2d-9b57-00bee82ae179-591580.png)
çº¿ç¨‹æ± ç‰¹ç‚¹ï¼š

- æœ€å¤§çº¿ç¨‹æ•°ä¸ºInteger.MAX_VALUEï¼Œä¹Ÿæœ‰OOMçš„é£é™©
- é˜»å¡é˜Ÿåˆ—æ˜¯DelayedWorkQueue
- keepAliveTimeä¸º0
- scheduleAtFixedRate() ï¼šæŒ‰æŸç§é€Ÿç‡å‘¨æœŸæ‰§è¡Œ
- scheduleWithFixedDelay()ï¼šåœ¨æŸä¸ªå»¶è¿Ÿåæ‰§è¡Œ

![image.png](./img/_kjzzIE5Zr7q1k8N/1685970012758-d14524a9-d5a2-41fa-97f9-01826e0904b3-701627.png)
![image.png](./img/_kjzzIE5Zr7q1k8N/1685970118955-98b1a8a7-972b-4df6-94f4-dbaa4b73c6a5-335085.png)
å·¥ä½œæµç¨‹ï¼š

- çº¿ç¨‹ä»DelayQueueä¸­è·å–å·²åˆ°æœŸçš„ScheduledFutureTaskï¼ˆDelayQueue.take()ï¼‰ã€‚åˆ°æœŸä»»åŠ¡æ˜¯æŒ‡ScheduledFutureTaskçš„timeå¤§äºç­‰äºå½“å‰æ—¶é—´ã€‚
- çº¿ç¨‹æ‰§è¡Œè¿™ä¸ªScheduledFutureTaskã€‚
- çº¿ç¨‹ä¿®æ”¹ScheduledFutureTaskçš„timeå˜é‡ä¸ºä¸‹æ¬¡å°†è¦è¢«æ‰§è¡Œçš„æ—¶é—´ã€‚
- çº¿ç¨‹æŠŠè¿™ä¸ªä¿®æ”¹timeä¹‹åçš„ScheduledFutureTaskæ”¾å›DelayQueueä¸­ï¼ˆDelayQueue.add()ï¼‰ã€‚

ä½¿ç”¨åœºæ™¯ï¼š
å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡çš„åœºæ™¯ï¼Œéœ€è¦é™åˆ¶çº¿ç¨‹æ•°é‡çš„åœºæ™¯ã€‚
```java
import java.util.concurrent.*;

/**
 * @author ç™¾é‡Œ
 */
public class BaiLiScheduledThreadPoolDemo {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºä¸€ä¸ªå¯ä»¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„çº¿ç¨‹æ± 
        ScheduledExecutorService executorService = Executors.newScheduledThreadPool(1);

        // è°ƒåº¦ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš” 2 ç§’é’Ÿè¾“å‡ºä¸€æ¬¡å½“å‰æ—¶é—´
        ScheduledFuture<?> scheduledFuture = executorService.scheduleAtFixedRate(() -> {
            System.out.println("Current time: " + System.currentTimeMillis());
        }, 0, 2, TimeUnit.SECONDS);

        // ä¸»çº¿ç¨‹ä¼‘çœ  10 ç§’é’Ÿåå–æ¶ˆä»»åŠ¡
        Thread.sleep(10000);
        scheduledFuture.cancel(true);

        // å…³é—­çº¿ç¨‹æ± 
        executorService.shutdown();
    }
}
```
```java
import java.util.concurrent.*;

/**
 * @author ç™¾é‡Œ
 */
public class BaiLiScheduleWithFixedDelayDemo {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºä¸€ä¸ªå¯ä»¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„çº¿ç¨‹æ± 
        ScheduledExecutorService executorService = Executors.newScheduledThreadPool(1);

        // è°ƒåº¦ä¸€ä¸ªå‘¨æœŸæ€§ä»»åŠ¡ï¼Œæ¯æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åç­‰å¾… 2 ç§’é’Ÿå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡
        executorService.scheduleWithFixedDelay(() -> {
            System.out.println("Current time: " + System.currentTimeMillis());
        }, 0, 2, TimeUnit.SECONDS);

        // ä¸»çº¿ç¨‹ä¼‘çœ  10 ç§’é’Ÿåå…³é—­çº¿ç¨‹æ± 
        Thread.sleep(10000);
        executorService.shutdown();
    }
}
```

# 46.çº¿ç¨‹æ± å¼‚å¸¸æ€ä¹ˆå¤„ç†çŸ¥é“å—ï¼Ÿ
åœ¨ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†ä»»åŠ¡çš„æ—¶å€™ï¼Œä»»åŠ¡ä»£ç å¯èƒ½æŠ›å‡ºRuntimeExceptionï¼ŒæŠ›å‡ºå¼‚å¸¸åï¼Œçº¿ç¨‹æ± å¯èƒ½æ•è·å®ƒï¼Œä¹Ÿå¯èƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥ä»£æ›¿å¼‚å¸¸çš„çº¿ç¨‹ï¼Œæˆ‘ä»¬å¯èƒ½æ— æ³•æ„ŸçŸ¥ä»»åŠ¡å‡ºç°äº†å¼‚å¸¸ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è€ƒè™‘çº¿ç¨‹æ± å¼‚å¸¸æƒ…å†µã€‚
å¸¸è§çš„å¼‚å¸¸å¤„ç†æ–¹å¼ï¼š
![1686550077887-0ecdea37-b484-4989-9deb-297e7b805919.jpeg](./img/_kjzzIE5Zr7q1k8N/1686550077887-0ecdea37-b484-4989-9deb-297e7b805919-657519.jpeg)
1.try-catchæ•è·å¼‚å¸¸
```java
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

/**
 * @author ç™¾é‡Œ
 */
public class BaiLiHandlerException implements Runnable {

    @Override
    public void run() {
        try {
            // ä»»åŠ¡ä»£ç 
            int a = 10 / 0;
        } catch (Exception e) {
            System.err.println("ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸ï¼š" + e.getMessage());
        }
    }

    public static void main(String[] args) {
        ExecutorService executor = Executors.newFixedThreadPool(10);
        BaiLiHandlerException task = new BaiLiHandlerException();
        executor.execute(task);
    }
}
```
2.ä½¿ç”¨Thread.UncaughtExceptionHandlerå¤„ç†å¼‚å¸¸
```java
import com.google.common.util.concurrent.ThreadFactoryBuilder;

import java.util.concurrent.*;

/**
 * @author ç™¾é‡Œ
 */
public class BaiLiHandlerException implements Runnable {


    @Override
    public void run() {
        // ä»»åŠ¡ä»£ç 
        int a = 10 / 0;
    }

    public static class MyUncaughtExceptionHandler implements Thread.UncaughtExceptionHandler {
        @Override
        public void uncaughtException(Thread t, Throwable e) {
            System.err.println("ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸ï¼š" + e.getMessage());
        }
    }

    public static void main(String[] args) {
        BaiLiHandlerException task = new BaiLiHandlerException();
        Thread thread = new Thread(task);
        thread.setUncaughtExceptionHandler(new MyUncaughtExceptionHandler());
        thread.start();
    }
}
```
3.é‡å†™ThreadPoolExecutor.afterExcuteå¤„ç†å¼‚å¸¸
```java
package exception;

import com.google.common.util.concurrent.ThreadFactoryBuilder;

import java.util.concurrent.*;

/**
 * @author ç™¾é‡Œ
 */
public class BaiLiHandlerException implements Runnable {


    @Override
    public void run() {
        // ä»»åŠ¡ä»£ç 
        int a = 10 / 0;
    }

    public static class MyThreadPoolExecutor extends ThreadPoolExecutor {
        public MyThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit,
                                    BlockingQueue<Runnable> workQueue, ThreadFactory threadFactory) {
            super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory);
        }

        @Override
        protected void afterExecute(Runnable r, Throwable t) {
            super.afterExecute(r, t);
            if (t != null) {
                System.err.println("ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸ï¼š" + t.getMessage());
            }
        }
    }

    public static void main(String[] args) {
        MyThreadPoolExecutor executor = new MyThreadPoolExecutor(1, 1, 0, TimeUnit.MILLISECONDS,
                new LinkedBlockingQueue<>(), new ThreadFactoryBuilder().setNameFormat("MyThread-%d").build());
        BaiLiHandlerException task = new BaiLiHandlerException();
        executor.execute(task);

    }
}
```
4.ä½¿ç”¨future.getå¤„ç†å¼‚å¸¸
```java
import com.google.common.util.concurrent.ThreadFactoryBuilder;

import java.util.concurrent.*;

/**
 * @author ç™¾é‡Œ
 */
public class BaiLiHandlerException {
    public static void main(String[] args) {
        ExecutorService executor = Executors.newSingleThreadExecutor();
        Future<String> future = executor.submit(() -> {
            throw new RuntimeException("ä»»åŠ¡æ‰§è¡Œå¤±è´¥");
        });
        try {
            String result = future.get();
            System.out.println(result);
        } catch (ExecutionException e) {
            Throwable ex = e.getCause();
            System.out.println("æ•è·åˆ°å¼‚å¸¸: " + ex.getMessage());
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            executor.shutdownNow();
            System.out.println("çº¿ç¨‹è¢«ä¸­æ–­ï¼Œå·²æ‰§è¡Œç›¸åº”å¤„ç†");
        }
        executor.shutdown();
    }
}
```

# 47.èƒ½è¯´ä¸€ä¸‹çº¿ç¨‹æ± æœ‰å‡ ç§çŠ¶æ€å—ï¼Ÿ
çº¿ç¨‹æ± æœ‰è¿™å‡ ä¸ªçŠ¶æ€ï¼šRUNNINGï¼ŒSHUTDOWNï¼ŒSTOPï¼ŒTIDYINGï¼ŒTERMINATED
```java
 //çº¿ç¨‹æ± çŠ¶æ€
private static final int RUNNING    = -1 << COUNT_BITS;
private static final int SHUTDOWN   =  0 << COUNT_BITS;
private static final int STOP       =  1 << COUNT_BITS;
private static final int TIDYING    =  2 << COUNT_BITS;
private static final int TERMINATED =  3 << COUNT_BITS;
```
çº¿ç¨‹æ± å„ä¸ªçŠ¶æ€åˆ‡æ¢å›¾ï¼š
![image.png](./img/_kjzzIE5Zr7q1k8N/1685970767469-4ae875f6-21d8-419b-976d-7307e159cffd-875896.png)
RUNNING

- è¯¥çŠ¶æ€çš„çº¿ç¨‹æ± ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œå¹¶å¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡;
- è°ƒç”¨çº¿ç¨‹æ± çš„shutdown()æ–¹æ³•ï¼Œå¯ä»¥åˆ‡æ¢åˆ°SHUTDOWNçŠ¶æ€;
- è°ƒç”¨çº¿ç¨‹æ± çš„shutdownNow()æ–¹æ³•ï¼Œå¯ä»¥åˆ‡æ¢åˆ°STOPçŠ¶æ€;

SHUTDOWN

- è¯¥çŠ¶æ€çš„çº¿ç¨‹æ± ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†ä¼šå¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼›
- é˜Ÿåˆ—ä¸ºç©ºï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡ä¹Ÿä¸ºç©º,è¿›å…¥TIDYINGçŠ¶æ€;

STOP

- è¯¥çŠ¶æ€çš„çº¿ç¨‹ä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šå¤„ç†é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œè€Œä¸”ä¼šä¸­æ–­æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼›
- çº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡ä¸ºç©º,è¿›å…¥TIDYINGçŠ¶æ€;

TIDYING

- è¯¥çŠ¶æ€è¡¨æ˜æ‰€æœ‰çš„ä»»åŠ¡å·²ç»è¿è¡Œç»ˆæ­¢ï¼Œè®°å½•çš„ä»»åŠ¡æ•°é‡ä¸º0ã€‚
- terminated()æ‰§è¡Œå®Œæ¯•ï¼Œè¿›å…¥TERMINATEDçŠ¶æ€

TERMINATED

- è¯¥çŠ¶æ€è¡¨ç¤ºçº¿ç¨‹æ± å½»åº•ç»ˆæ­¢

# 48.å•æœºçº¿ç¨‹æ± æ‰§è¡Œæ–­ç”µäº†åº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ
å•æœºçº¿ç¨‹æ± æ˜¯ä¸€ç§å¸¸è§çš„å¤šçº¿ç¨‹ç¼–ç¨‹æ–¹å¼ï¼Œå®ƒå¯ä»¥ç”¨äºå¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œæé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œå¹¶å‘èƒ½åŠ›ã€‚åœ¨å•æœºçº¿ç¨‹æ± ä¸­ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½ç”±åŒä¸€ä¸ªçº¿ç¨‹å¤„ç†ï¼Œå› æ­¤å¦‚æœè¯¥çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡æ—¶çªç„¶æ–­ç”µï¼Œåˆ™ä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼š

- ä»»åŠ¡ä¸å®Œæ•´
- æ•°æ®ä¸¢å¤±
- ç³»ç»Ÿèµ„æºæ³„æ¼

å¦‚æœå•æœºçº¿ç¨‹æ± åœ¨æ‰§è¡Œä»»åŠ¡æ—¶çªç„¶é‡åˆ°æ–­ç”µç­‰å¼‚å¸¸æƒ…å†µï¼Œåº”è¯¥å°½å¿«é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

- æ¢å¤ä¸­æ–­çš„ä»»åŠ¡ï¼šå½“ç³»ç»Ÿé‡æ–°å¯åŠ¨åï¼Œéœ€è¦æ£€æŸ¥ä¹‹å‰è¢«ä¸­æ–­çš„ä»»åŠ¡ï¼Œå¹¶å°†å…¶é‡æ–°æäº¤åˆ°å•æœºçº¿ç¨‹æ± ä¸­è¿›è¡Œå¤„ç†ï¼Œä»¥ç¡®ä¿æ‰€æœ‰ä»»åŠ¡éƒ½èƒ½å¤Ÿè¢«æ­£ç¡®æ‰§è¡Œã€‚
- æ•°æ®å¤‡ä»½åŠæ¢å¤ï¼šå¯¹äºéœ€è¦å¤„ç†çš„æ•°æ®ï¼Œåº”è¯¥äº‹å…ˆè¿›è¡Œå¤‡ä»½ï¼Œä»¥é¿å…æ•°æ®ä¸¢å¤±æˆ–æŸåã€‚åœ¨ç³»ç»Ÿé‡å¯åï¼Œéœ€è¦å°†å¤‡ä»½æ•°æ®æ¢å¤åˆ°ç³»ç»Ÿä¸­ï¼Œä»¥ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ã€‚
- ç³»ç»Ÿèµ„æºæ¸…ç†ï¼šåœ¨å•æœºçº¿ç¨‹æ± æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæœªé‡Šæ”¾çš„ç³»ç»Ÿèµ„æºï¼Œå¦‚æ–‡ä»¶å¥æŸ„ã€é”ç­‰ã€‚åœ¨ç³»ç»Ÿé‡å¯åï¼Œéœ€è¦æ¸…ç†è¿™äº›æœªé‡Šæ”¾çš„ç³»ç»Ÿèµ„æºï¼Œä»¥é¿å…èµ„æºæ³„æ¼å’Œç³»ç»Ÿè¿è¡Œä¸ç¨³å®šã€‚

# 49.NIOçš„åŸç†ï¼ŒåŒ…æ‹¬å“ªå‡ ä¸ªç»„ä»¶ï¼Ÿ
NIOï¼ˆJava Non-blocking I/Oï¼‰æ˜¯ä¸€ç§ I/O æŠ€æœ¯ï¼Œå…¶æ ¸å¿ƒåŸç†æ˜¯åŸºäºäº‹ä»¶é©±åŠ¨çš„æ–¹å¼è¿›è¡Œæ“ä½œã€‚
**NIO çš„å·¥ä½œåŸç†**ï¼šåŸºäºç¼“å†²åŒºã€é€šé“å’Œé€‰æ‹©å™¨çš„ç»„åˆï¼Œé€šè¿‡é«˜æ•ˆåœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºï¼Œä»¥æ”¯æŒé«˜å¹¶å‘å’Œé«˜ååé‡çš„æ•°æ®å¤„ç†ã€‚ç›¸æ¯”ä¼ ç»Ÿçš„ I/O ç¼–ç¨‹æ–¹å¼ï¼ŒJava NIO æä¾›äº†æ›´ä¸ºçµæ´»å’Œé«˜æ•ˆçš„ç¼–ç¨‹æ–¹å¼ã€‚
NIOä¸‰å¤§æ ¸å¿ƒç»„ä»¶ï¼š Channelï¼ˆé€šé“ï¼‰ã€Bufferï¼ˆç¼“å†²åŒºï¼‰ã€Selectorï¼ˆé€‰æ‹©å™¨ï¼‰ã€‚
Selectorã€Channel å’Œ Buffer çš„å…³ç³»å›¾å¦‚ä¸‹ï¼š
![v2-e5a21277c1bb27654837602147185f76_b.jpg](./img/_kjzzIE5Zr7q1k8N/1686557237688-566b0bc7-67ab-4f65-830c-4f9dc9599e9d-980490.jpeg)

1. Channelï¼ˆé€šé“ï¼‰ï¼šç±»ä¼¼äºä¼ ç»Ÿ I/O ä¸­çš„ Streamï¼Œæ˜¯ç”¨äºå®é™…æ•°æ®ä¼ è¾“çš„ç»„ä»¶ã€‚åœ¨ NIO ä¸­ï¼Œæœ‰å¤šç§ç±»å‹çš„ Channel å¯ä»¥ä½¿ç”¨ï¼Œä¾‹å¦‚ FileChannelã€SocketChannelã€DatagramChannel ç­‰ï¼Œå¯ç”¨äºæ–‡ä»¶æ“ä½œã€ç½‘ç»œä¼ è¾“ç­‰ä¸åŒåœºæ™¯ã€‚
2. Bufferï¼ˆç¼“å†²åŒºï¼‰ï¼šç”¨äºå­˜å‚¨æ•°æ®çš„å®¹å™¨ï¼Œå¯ä»¥ç†è§£ä¸ºæš‚å­˜éœ€è¦ä¼ è¾“çš„æ•°æ®çš„åœ°æ–¹ã€‚åœ¨ NIO ä¸­ï¼Œå­˜åœ¨å¤šç§ç±»å‹çš„ç¼“å†²åŒºï¼Œå¦‚ ByteBufferã€CharBufferã€IntBufferç­‰ã€‚
3. Selectorï¼ˆé€‰æ‹©å™¨ï¼‰ï¼šç”¨äºæ³¨å†Œ Channel å¹¶ç›‘å¬å…¶ I/O äº‹ä»¶ã€‚å½“ Channel å‡†å¤‡å¥½è¯»æˆ–å†™æ•°æ®æ—¶ï¼Œä¼šå¾—åˆ°é€šçŸ¥ã€‚Selector å¯ä»¥é«˜æ•ˆåœ°è½®è¯¢å¤šä¸ª Channelï¼Œå¹¶ä¸”é¿å…äº†ä½¿ç”¨å¤šçº¿ç¨‹æˆ–å¤šè¿›ç¨‹å¯¹å¤šä¸ª Channel è¿›è¡Œè½®è¯¢çš„æƒ…å†µï¼Œä»è€Œå‡å°‘äº†ç³»ç»Ÿèµ„æºå¼€é”€ã€‚

**é€šä¿—ç†è§£NIOåŸç†**ï¼š
NIO æ˜¯å¯ä»¥åšåˆ°ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å¤šä¸ªæ“ä½œçš„ã€‚å‡è®¾æœ‰ 10000 ä¸ªè¯·æ±‚è¿‡æ¥ï¼Œæ ¹æ®å®é™…æƒ…å†µï¼Œå¯ä»¥åˆ†é… 50 æˆ–è€… 100 ä¸ªçº¿ç¨‹æ¥å¤„ç†ã€‚ä¸åƒä¹‹å‰çš„é˜»å¡ IO é‚£æ ·ï¼Œéå¾—åˆ†é… 10000 ä¸ªã€‚

# 50.ä»€ä¹ˆæ˜¯é›¶æ‹·è´ï¼Ÿ
é›¶æ‹·è´ï¼ˆZero-Copyï¼‰æ˜¯ä¸€ç§ `I/O` æ“ä½œä¼˜åŒ–æŠ€æœ¯ï¼Œå¯ä»¥å¿«é€Ÿé«˜æ•ˆåœ°å°†æ•°æ®ä»æ–‡ä»¶ç³»ç»Ÿç§»åŠ¨åˆ°ç½‘ç»œæ¥å£ï¼Œè€Œä¸éœ€è¦å°†å…¶ä»å†…æ ¸ç©ºé—´å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ã€‚
**ä¼ ç»ŸI/Oæ“ä½œè¿‡ç¨‹ï¼š**
ä¼ ç»Ÿ I/O çš„å·¥ä½œæ–¹å¼æ˜¯ï¼Œæ•°æ®è¯»å–å’Œå†™å…¥æ˜¯ä»ç”¨æˆ·ç©ºé—´åˆ°å†…æ ¸ç©ºé—´æ¥å›å¤åˆ¶ï¼Œè€Œå†…æ ¸ç©ºé—´çš„æ•°æ®æ˜¯é€šè¿‡æ“ä½œç³»ç»Ÿå±‚é¢çš„ I/O æ¥å£ä»ç£ç›˜è¯»å–æˆ–å†™å…¥ã€‚ä»£ç é€šå¸¸å¦‚ä¸‹ï¼Œä¸€èˆ¬ä¼šéœ€è¦ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼š
```java
read(file, tmp_buf, len);
write(socket, tmp_buf, len);
```
ä»£ç å¾ˆç®€å•ï¼Œè™½ç„¶å°±ä¸¤è¡Œä»£ç ï¼Œä½†æ˜¯è¿™é‡Œé¢å‘ç”Ÿäº†ä¸å°‘çš„äº‹æƒ…ï¼š
![image.png](./img/_kjzzIE5Zr7q1k8N/1686571779937-9f94b405-1366-4964-96b0-a9bd04d915ef-521063.png)

- ç”¨æˆ·åº”ç”¨è¿›ç¨‹è°ƒç”¨readå‡½æ•°ï¼Œå‘æ“ä½œç³»ç»Ÿå‘èµ·IOè°ƒç”¨ï¼Œ**ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€è½¬ä¸ºå†…æ ¸æ€ï¼ˆåˆ‡æ¢1ï¼‰**
- DMAæ§åˆ¶å™¨æŠŠæ•°æ®ä»ç£ç›˜ä¸­ï¼Œè¯»å–åˆ°å†…æ ¸ç¼“å†²åŒºã€‚
- CPUæŠŠå†…æ ¸ç¼“å†²åŒºæ•°æ®ï¼Œæ‹·è´åˆ°ç”¨æˆ·åº”ç”¨ç¼“å†²åŒºï¼Œ**ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€è½¬ä¸ºç”¨æˆ·æ€ï¼ˆåˆ‡æ¢2ï¼‰**ï¼Œreadå‡½æ•°è¿”å›
- ç”¨æˆ·åº”ç”¨è¿›ç¨‹é€šè¿‡writeå‡½æ•°ï¼Œå‘èµ·IOè°ƒç”¨ï¼Œ**ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€è½¬ä¸ºå†…æ ¸æ€ï¼ˆåˆ‡æ¢3ï¼‰**
- CPUå°†åº”ç”¨ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œæ‹·è´åˆ°socketç¼“å†²åŒº
- DMAæ§åˆ¶å™¨æŠŠæ•°æ®ä»socketç¼“å†²åŒºï¼Œæ‹·è´åˆ°ç½‘å¡è®¾å¤‡ï¼Œ**ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆåˆ‡æ¢4ï¼‰**ï¼Œwriteå‡½æ•°è¿”å›

ä»æµç¨‹å›¾å¯ä»¥çœ‹å‡ºï¼Œä¼ ç»ŸIOçš„è¯»å†™æµç¨‹ï¼ŒåŒ…æ‹¬äº†4æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆ4æ¬¡ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼‰ï¼Œ4æ¬¡æ•°æ®æ‹·è´ï¼ˆ**ä¸¤æ¬¡CPUæ‹·è´ä»¥åŠä¸¤æ¬¡çš„DMAæ‹·è´**)
è¿™ç§ç®€å•åˆä¼ ç»Ÿçš„æ–‡ä»¶ä¼ è¾“æ–¹å¼ï¼Œå­˜åœ¨å†—ä½™çš„ä¸Šæ–‡åˆ‡æ¢å’Œæ•°æ®æ‹·è´ï¼Œåœ¨é«˜å¹¶å‘ç³»ç»Ÿé‡Œæ˜¯éå¸¸ç³Ÿç³•çš„ï¼Œå¤šäº†å¾ˆå¤šä¸å¿…è¦çš„å¼€é”€ï¼Œä¼šä¸¥é‡å½±å“ç³»ç»Ÿæ€§èƒ½ã€‚
æ‰€ä»¥ï¼Œ**è¦æƒ³æé«˜æ–‡ä»¶ä¼ è¾“çš„æ€§èƒ½ï¼Œå°±éœ€è¦å‡å°‘ã€Œç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€å’Œã€Œå†…å­˜æ‹·è´ã€çš„æ¬¡æ•°**ã€‚
é›¶æ‹·è´ä¸»è¦æ˜¯ç”¨æ¥è§£å†³æ“ä½œç³»ç»Ÿåœ¨å¤„ç† I/O æ“ä½œæ—¶ï¼Œé¢‘ç¹å¤åˆ¶æ•°æ®çš„é—®é¢˜ã€‚å…³äºé›¶æ‹·è´ä¸»è¦æŠ€æœ¯æœ‰MMap+Writeã€SendFileç­‰å‡ ç§æ–¹å¼ã€‚
**Mmap+Wirteå®ç°é›¶æ‹·è´**ï¼š
![image.png](./img/_kjzzIE5Zr7q1k8N/1686572758863-e02d5429-33b1-4967-881f-a14a4af6f9b1-287031.png)

- ç”¨æˆ·è¿›ç¨‹é€šè¿‡mmapæ–¹æ³•å‘æ“ä½œç³»ç»Ÿå†…æ ¸å‘èµ·IOè°ƒç”¨ï¼Œ**ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€åˆ‡æ¢ä¸ºå†…æ ¸æ€**ã€‚
- CPUåˆ©ç”¨DMAæ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä»ç¡¬ç›˜ä¸­æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºã€‚
- **ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€**ï¼Œmmapæ–¹æ³•è¿”å›ã€‚
- ç”¨æˆ·è¿›ç¨‹é€šè¿‡writeæ–¹æ³•å‘æ“ä½œç³»ç»Ÿå†…æ ¸å‘èµ·IOè°ƒç”¨ï¼Œ**ä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€åˆ‡æ¢ä¸ºå†…æ ¸æ€**ã€‚
- CPUå°†å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°çš„socketç¼“å†²åŒºã€‚
- CPUåˆ©ç”¨DMAæ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä»socketç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡ï¼Œ**ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€**ï¼Œwriteè°ƒç”¨è¿”å›ã€‚

å¯ä»¥å‘ç°ï¼Œmmap+writeå®ç°çš„é›¶æ‹·è´ï¼ŒI/Oå‘ç”Ÿäº†**4**æ¬¡ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥åŠ3æ¬¡æ•°æ®æ‹·è´ã€‚å…¶ä¸­3æ¬¡æ•°æ®æ‹·è´ä¸­ï¼ŒåŒ…æ‹¬äº†**2æ¬¡DMAæ‹·è´å’Œ1æ¬¡CPUæ‹·è´**ã€‚
**SendFileå®ç°é›¶æ‹·è´**ï¼š
![image.png](./img/_kjzzIE5Zr7q1k8N/1686572781440-6527ed02-7aff-4655-a855-57f703685807-492393.png)

1. ç”¨æˆ·è¿›ç¨‹å‘èµ·sendfileç³»ç»Ÿè°ƒç”¨ï¼Œ**ä¸Šä¸‹æ–‡ï¼ˆåˆ‡æ¢1ï¼‰ä»ç”¨æˆ·æ€è½¬å‘å†…æ ¸æ€**
2. DMAæ§åˆ¶å™¨ï¼ŒæŠŠæ•°æ®ä»ç¡¬ç›˜ä¸­æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºã€‚
3. CPUå°†è¯»ç¼“å†²åŒºä¸­æ•°æ®æ‹·è´åˆ°socketç¼“å†²åŒº
4. DMAæ§åˆ¶å™¨ï¼Œå¼‚æ­¥æŠŠæ•°æ®ä»socketç¼“å†²åŒºæ‹·è´åˆ°ç½‘å¡ï¼Œ
5. **ä¸Šä¸‹æ–‡ï¼ˆåˆ‡æ¢2ï¼‰ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€**ï¼Œsendfileè°ƒç”¨è¿”å›ã€‚

å¯ä»¥å‘ç°ï¼Œsendfileå®ç°çš„é›¶æ‹·è´ï¼ŒI/Oå‘ç”Ÿäº†**2**æ¬¡ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä»¥åŠ3æ¬¡æ•°æ®æ‹·è´ã€‚å…¶ä¸­3æ¬¡æ•°æ®æ‹·è´ä¸­ï¼ŒåŒ…æ‹¬äº†**2æ¬¡DMAæ‹·è´å’Œ1æ¬¡CPUæ‹·è´**ã€‚



> åŸæ–‡: <https://www.yuque.com/tulingzhouyu/db22bv/tupelds42978mtt8>